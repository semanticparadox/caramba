{% extends "base.html" %}

{% block title %}Traffic Analytics{% endblock %}
{% block header_title %}Network Traffic Analytics{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Traffic (All Time) -->
    <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 p-6 rounded-2xl relative overflow-hidden group hover:border-indigo-500/30 transition-all duration-300">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i data-lucide="activity" class="w-16 h-16 text-indigo-500"></i>
        </div>
        <div class="flex items-center justify-between mb-4">
            <div class="p-3 bg-indigo-500/10 rounded-xl text-indigo-400">
                <i data-lucide="activity" class="w-6 h-6"></i>
            </div>
        </div>
        <div>
            <p class="text-slate-400 text-sm font-medium mb-1">Total Traffic (30d)</p>
            <h3 class="text-3xl font-bold text-white">{{ total_traffic_30d }}</h3>
        </div>
    </div>

    <!-- Active Nodes -->
    <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 p-6 rounded-2xl relative overflow-hidden group hover:border-emerald-500/30 transition-all duration-300">
        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <i data-lucide="server" class="w-16 h-16 text-emerald-500"></i>
        </div>
        <div class="flex items-center justify-between mb-4">
            <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400">
                <i data-lucide="server" class="w-6 h-6"></i>
            </div>
        </div>
        <div>
            <p class="text-slate-400 text-sm font-medium mb-1">Active Nodes</p>
            <h3 class="text-3xl font-bold text-emerald-400">{{ active_nodes_count }}</h3>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- Area Chart: Traffic History -->
    <div class="lg:col-span-2 bg-slate-900/50 backdrop-blur-md border border-white/5 p-6 rounded-2xl">
        <h3 class="text-lg font-semibold text-white mb-6">Traffic History (Last 30 Days)</h3>
        <div id="trafficHistoryChart" class="w-full min-h-[350px]"></div>
    </div>

    <!-- Donut Chart: Node Distribution -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 p-6 rounded-2xl">
        <h3 class="text-lg font-semibold text-white mb-6">Traffic by Node</h3>
        <div id="nodeDistributionChart" class="w-full min-h-[350px] flex items-center justify-center"></div>
    </div>
</div>

<!-- Top Users Table -->
<div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden">
    <div class="p-6 border-b border-white/5">
        <h3 class="text-lg font-semibold text-white">Top 10 High-Bandwidth Users</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5">
                    <th class="px-6 py-4">Username</th>
                    <th class="px-6 py-4 text-right">Total Usage</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5 text-sm">
                {% for user in top_users %}
                <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 font-medium text-white">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                <i data-lucide="user" class="w-4 h-4"></i>
                            </div>
                            {{ user.username.as_deref().unwrap_or("Unknown") }}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right text-slate-300 font-mono">
                        {{ user.total_traffic_fmt }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- Traffic History Chart (Area) ---
    var historyOptions = {
        series: [{
            name: 'Traffic (GB)',
            data: {{ history_data_json| safe }}
        }],
    chart: {
        height: 350,
            type: 'area',
                toolbar: { show: false },
        fontFamily: 'Inter, sans-serif',
            background: 'transparent'
    },
    dataLabels: { enabled: false },
    stroke: {
        curve: 'smooth',
            width: 3,
                colors: ['#FF6B35']
    },
    xaxis: {
        categories: { { history_labels_json | safe } },
        labels: { style: { colors: '#94a3b8', fontSize: '12px' } },
        axisBorder: { show: false },
        axisTicks: { show: false }
    },
    yaxis: {
        labels: { style: { colors: '#94a3b8', fontSize: '12px' } }
    },
    grid: {
        borderColor: 'rgba(255,255,255,0.05)',
            strokeDashArray: 4
    },
    theme: { mode: 'dark' },
    fill: {
        type: 'gradient',
            gradient: {
            shadeIntensity: 1,
                opacityFrom: 0.3,
                    opacityTo: 0.05,
                        stops: [0, 90, 100],
                            colorStops: [
                                { offset: 0, color: '#FF6B35', opacity: 0.4 },
                                { offset: 100, color: '#FF6B35', opacity: 0 }
                            ]
        }
    }
    };
    var historyChart = new ApexCharts(document.querySelector("#trafficHistoryChart"), historyOptions);
    historyChart.render();

    // --- Node Distribution Chart (Donut) ---
    var nodeOptions = {
        series: {{ node_series_json| safe }},
    labels: { { node_labels_json | safe } },
    chart: {
        type: 'donut',
            height: 350,
                background: 'transparent'
    },
    plotOptions: {
        pie: {
            donut: {
                size: '70%',
                    labels: {
                    show: true,
                        name: { color: '#94a3b8' },
                    value: { color: '#ffffff' },
                    total: {
                        show: true,
                            label: 'Total',
                                color: '#94a3b8',
                                    formatter: function (w) {
                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0).toFixed(1) + " GB"
                                    }
                    }
                }
            }
        }
    },
    stroke: { show: false },
    dataLabels: { enabled: false },
    legend: {
        position: 'bottom',
            labels: { colors: '#94a3b8' }
    },
    theme: { mode: 'dark' },
    colors: ['#FF6B35', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
    };
    var nodeChart = new ApexCharts(document.querySelector("#nodeDistributionChart"), nodeOptions);
    nodeChart.render();
</script>
{% endblock %}