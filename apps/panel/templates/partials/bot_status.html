<div id="bot-status-container" class="space-y-4">
    <div class="flex items-center justify-between">
        <div>
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border {% if bot_status == "
                running" %}bg-emerald-500/10 text-emerald-400 border-emerald-500/20{% else %}bg-red-500/10 text-red-400
                border-red-500/20{% endif %}">
                <span class="w-1.5 h-1.5 rounded-full mr-1.5 {% if bot_status == " running" %}bg-emerald-500{% else
                    %}bg-red-500{% endif %}"></span>
                {{ bot_status|capitalize }}
            </span>
        </div>
        <button
            class="px-4 py-2 rounded-lg text-sm font-medium transition-all focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-indigo-500 {% if bot_status == "
            running" %}bg-white/5 text-slate-300 hover:bg-white/10 hover:text-white border border-white/10{% else
            %}bg-indigo-600 text-white hover:bg-indigo-500 shadow-lg shadow-indigo-500/20{% endif %}"
            hx-post="{{ admin_path }}/settings/bot/toggle" hx-target="#bot-status-container" hx-swap="outerHTML">
            {% if bot_status == "running" %}Stop Service{% else %}Start Service{% endif %}
        </button>
    </div>

    <!-- Terminal Window -->
    <div class="rounded-xl overflow-hidden bg-[#0a0a0a] border border-white/10 shadow-2xl font-mono text-xs">
        <!-- Terminal Header -->
        <div class="bg-[#1a1a1a] px-4 py-2 flex items-center justify-between border-b border-white/5">
            <div class="flex space-x-1.5">
                <div class="w-2.5 h-2.5 rounded-full bg-red-500/80"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-amber-500/80"></div>
                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500/80"></div>
            </div>
            <div class="text-slate-500 font-medium text-[10px] tracking-wide">bot@exa-robot:~</div>
            <div class="w-10"></div> <!-- Spacer for balance -->
        </div>

        <!-- Terminal Body -->
        <div id="bot-console" class="h-[200px] overflow-y-auto p-4 space-y-1 scroll-smooth">
            <div class="text-slate-500 mb-2">Last login: Mon Jan 01 12:00:00 on ttys000</div>
            <div id="bot-console-content" class="text-emerald-400/90 leading-relaxed whitespace-pre-wrap">Initializing
                session...</div>
            <div class="animate-pulse inline-block w-2 h-4 bg-slate-500 align-middle ml-1"></div>
        </div>
    </div>
</div>

<script>
    (function () {
        const consoleContent = document.getElementById('bot-console-content');
        const consoleContainer = document.getElementById('bot-console');

        function stripAnsi(text) {
            let clean = text.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
            // Simplify ISO Date 2026-01-19T05:06:12.202Z -> 05:06:12
            return clean.replace(/\d{4}-\d{2}-\d{2}T(\d{2}:\d{2}:\d{2})\.\d+Z/g, '$1');
        }

        async function fetchLogs() {
            try {
                const response = await fetch('{{ admin_path }}/bot-logs/history');
                if (response.ok) {
                    const text = await response.text();
                    consoleContent.innerText = stripAnsi(text);
                    consoleContainer.scrollTop = consoleContainer.scrollHeight;
                }
            } catch (e) {
                console.error("Failed to fetch bot logs", e);
            }
        }

        async function tailLogs() {
            try {
                const response = await fetch('{{ admin_path }}/bot-logs/tail');
                if (response.ok) {
                    const text = await response.text();
                    if (text.length > 0) {
                        const cleanText = stripAnsi(text);
                        const lines = cleanText.split('\n');
                        for (const line of lines) {
                            if (line.trim().length > 0) {
                                const div = document.createElement('div');
                                div.innerText = line;
                                consoleContent.appendChild(div);
                            }
                        }
                        consoleContainer.scrollTop = consoleContainer.scrollHeight;
                    }
                }
            } catch (e) {
                console.error("Failed to tail bot logs", e);
            }
        }

        fetchLogs();
        const interval = setInterval(tailLogs, 2000);

        document.body.addEventListener('htmx:beforeSwap', function (evt) {
            if (evt.detail.target.id === "bot-status-container") {
                clearInterval(interval);
            }
        });
    })();
</script>