{% for node in nodes %}
<tr id="node-row-{{ node.id }}"
    class="hover:bg-white/[0.03] transition-all duration-300 group {% if !node.is_enabled %}opacity-50 grayscale{% endif %}">
    <td class="px-6 py-5">
        <div class="flex flex-col">
            <div class="flex items-center gap-2.5 font-semibold text-white mb-1">
                {% if let Some(code) = node.country_code %}
                <img src="https://flagcdn.com/24x18/{{ code|lower }}.png" title="{{ code }}" width="20" height="15"
                    class="rounded-[2px] shadow-sm ring-1 ring-white/10">
                {% endif %}
                <span class="tracking-tight">{{ node.name }}</span>
            </div>
            <div class="text-[10px] text-slate-500 font-mono flex items-center gap-1.5">
                {% if node.status == "new" || node.status == "installing" %}
                <button
                    onclick="showConnectModal('{{ node.join_token.clone().unwrap_or_default() }}', '{{ node.name }}')"
                    class="px-2 py-0.5 rounded bg-indigo-500/10 text-indigo-400 hover:bg-indigo-500/20 transition-all flex items-center gap-1">
                    <i data-lucide="plug-2" class="w-3 h-3"></i>
                    <span>Connect Required</span>
                </button>
                {% else %}
                <i data-lucide="hash" class="w-3 h-3 opacity-50"></i>
                <span class="opacity-80">{{ node.ip }}</span>
                {% endif %}
            </div>
        </div>
    </td>
    <td class="px-6 py-5">
        {% if node.status == "active" %}
        <div
            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 shadow-[0_0_15px_-3px_rgba(16,185,129,0.2)]">
            <span class="relative flex h-2 w-2">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
            </span>
            Online
        </div>
        {% else if node.status == "offline" %}
        <div
            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-red-500/10 text-red-400 border border-red-500/20">
            <span class="w-2 h-2 rounded-full bg-red-500"></span> Offline
        </div>
        {% else %}
        <div
            class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-amber-500/10 text-amber-400 border border-amber-500/20">
            <span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> {{ node.status|capitalize }}
        </div>
        {% endif %}

        {% if !node.is_enabled %}
        <span
            class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-red-500/10 text-red-500 font-bold uppercase tracking-tighter">Disabled</span>
        {% endif %}
    </td>
    <td class="px-6 py-5">
        {% if node.status == "active" %}
        <div class="grid grid-cols-2 gap-x-8 gap-y-3 min-w-[320px]">
            <!-- System Health -->
            <div class="space-y-1.5">
                <div
                    class="flex items-center justify-between text-[10px] uppercase tracking-wider text-slate-500 font-bold">
                    <span>Resources</span>
                    <span class="text-slate-400 font-mono">{{ node.latency_rounded() }}ms</span>
                </div>
                <div class="flex items-center gap-4 text-xs font-mono">
                    <div class="flex items-center gap-1.5 group/stat" title="CPU Usage">
                        <i data-lucide="cpu" class="w-3.5 h-3.5 text-indigo-400"></i>
                        <span class="text-slate-200">{{ node.cpu_rounded() }}%</span>
                    </div>
                    <div class="flex items-center gap-1.5 group/stat" title="Memory Usage">
                        <i data-lucide="memory-stick" class="w-3.5 h-3.5 text-purple-400"></i>
                        <span class="text-slate-200">{{ node.ram_rounded() }}%</span>
                    </div>
                    <div class="flex items-center gap-1.5 group/stat" title="Uptime">
                        <i data-lucide="clock" class="w-3.5 h-3.5 text-emerald-400"></i>
                        <span class="text-slate-200">{{ node.format_uptime() }}</span>
                    </div>
                </div>
            </div>

            <!-- Network Usage -->
            <div class="space-y-1.5">
                <div
                    class="flex items-center justify-between text-[10px] uppercase tracking-wider text-slate-500 font-bold">
                    <span>Performance</span>
                    <span class="text-slate-400 font-mono">{{ node.current_speed_mbps }} Mbps</span>
                </div>
                <div class="flex items-center gap-4 text-xs font-mono">
                    <div class="flex items-center gap-1.5 group/stat" title="Active Connections">
                        <i data-lucide="users" class="w-3.5 h-3.5 text-blue-400"></i>
                        <span class="text-slate-200">{{ node.active_connections.unwrap_or(0) }}</span>
                    </div>
                    <div class="flex items-center gap-1.5 group/stat" title="Total Inbound">
                        <i data-lucide="arrow-down-circle" class="w-3.5 h-3.5 text-sky-400"></i>
                        <span class="text-slate-200">{{ node.format_traffic_ingress() }}</span>
                    </div>
                    <div class="flex items-center gap-1.5 group/stat" title="Total Outbound">
                        <i data-lucide="arrow-up-circle" class="w-3.5 h-3.5 text-orange-400"></i>
                        <span class="text-slate-200">{{ node.format_traffic_egress() }}</span>
                    </div>
                </div>
            </div>

            <!-- Routing/Disguise -->
            <div class="col-span-2 pt-1.5 border-t border-white/5 flex items-center justify-between">
                <div class="flex items-center gap-2 text-[10px] text-slate-500 font-medium">
                    <i data-lucide="shield-check" class="w-3.5 h-3.5 text-slate-600"></i>
                    <span>Mimicry:</span>
                    <span class="text-indigo-400/80 font-mono">{{
                        node.reality_sni.clone().unwrap_or("www.google.com".to_string()) }}</span>
                </div>
                <div class="flex items-center gap-2 text-[10px] text-slate-500 font-medium">
                    <i data-lucide="map-pin" class="w-3.5 h-3.5 text-slate-600"></i>
                    <span>Location:</span>
                    <span class="text-slate-300">{{ node.city.clone().unwrap_or("Unknown".to_string()) }}, {{
                        node.country.clone().unwrap_or("Earth".to_string()) }}</span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="flex items-center gap-2 text-slate-600 italic text-xs">
            <i data-lucide="monitor-off" class="w-4 h-4 opacity-50"></i>
            Metrics unavailable while offline
        </div>
        {% endif %}
    </td>
    <td class="px-6 py-5">
        {% if let Some(ls) = node.last_seen %}
        <div class="flex flex-col gap-1 items-end">
            <span class="text-xs text-slate-300 font-medium time-ago" data-time="{{ ls }}">{{ ls }}</span>
            <div
                class="flex items-center gap-1.5 text-[10px] text-slate-500 font-mono opacity-50 uppercase tracking-tighter">
                <i data-lucide="calendar" class="w-3 h-3"></i>
                {{ ls.format("%H:%M %d/%m") }}
            </div>
        </div>
        {% else %}
        <div class="flex flex-col items-end opacity-40">
            <span class="text-xs text-slate-600 font-medium">Never connected</span>
        </div>
        {% endif %}
    </td>
    <td class="px-6 py-5 text-right">
        <div class="flex items-center justify-end gap-3">
            <!-- Quick Toggle -->
            {% if node.status == "active" %}
            <button
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10 text-slate-400 hover:text-white transition-all duration-300 border border-transparent hover:border-white/10"
                hx-post="{{ admin_path }}/nodes/{{ node.id }}/toggle" hx-swap="none" hx-trigger="click consume"
                hx-on::after-request="htmx.trigger('body', 'refresh_nodes')"
                title="{% if node.is_enabled %}Disable{% else %}Enable{% endif %}">
                <i data-lucide="power"
                    class="w-4 h-4 {% if node.is_enabled %}text-emerald-500 drop-shadow-[0_0_8px_rgba(16,185,129,0.5)]{% else %}text-red-500{% endif %}"></i>
            </button>
            {% endif %}

            <!-- Actions Dropdown -->
            <div class="relative inline-block text-left" x-data="{ open: false }">
                <button @click="open = !open" @click.away="open = false"
                    class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-slate-950 border border-white/5 hover:border-indigo-500/30 text-xs font-bold text-slate-300 hover:text-white transition-all shadow-lg active:scale-95 group">
                    <span>Manage</span>
                    <i data-lucide="chevron-down"
                        class="w-3.5 h-3.5 opacity-50 group-hover:rotate-180 transition-transform"></i>
                </button>

                <div x-show="open" x-transition:enter="transition ease-out duration-100"
                    x-transition:enter-start="transform opacity-0 scale-95"
                    x-transition:enter-end="transform opacity-100 scale-100"
                    class="absolute right-0 mt-2 w-56 bg-slate-900/95 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl z-50 overflow-hidden py-1.5">

                    {% if node.status == "active" %}
                    <a href="{{ admin_path }}/nodes/{{ node.id }}/inbounds"
                        class="flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-slate-300 hover:bg-indigo-500/10 hover:text-indigo-400 transition-colors">
                        <i data-lucide="settings-2" class="w-4 h-4 opacity-50"></i>
                        Configure Inbounds
                    </a>
                    <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/test" hx-swap="none"
                        hx-on::after-request="showToast(event.detail.xhr.responseText)"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-slate-300 hover:bg-indigo-500/10 hover:text-indigo-400 transition-colors text-left">
                        <i data-lucide="activity" class="w-4 h-4 opacity-50"></i>
                        Test Connection
                    </button>
                    <button hx-get="{{ admin_path }}/nodes/{{ node.id }}/rescue" hx-target="#edit-node-modal-content"
                        hx-swap="innerHTML"
                        hx-on::after-request="document.getElementById('edit-node-modal').showModal()"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-orange-400 hover:bg-orange-500/10 transition-colors text-left font-bold">
                        <i data-lucide="shield-alert" class="w-4 h-4 opacity-70"></i>
                        Emergency Access
                    </button>
                    <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/sync" hx-swap="none"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-slate-300 hover:bg-indigo-500/10 hover:text-indigo-400 transition-colors text-left">
                        <i data-lucide="refresh-cw" class="w-4 h-4 opacity-50"></i>
                        Sync Configurations
                    </button>
                    <button hx-get="{{ admin_path }}/nodes/{{ node.id }}/logs" hx-target="#logs-modal-content"
                        hx-on::after-request="document.getElementById('logs-modal').showModal()"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-slate-300 hover:bg-indigo-500/10 hover:text-indigo-400 transition-colors text-left">
                        <i data-lucide="file-text" class="w-4 h-4 opacity-50"></i>
                        Terminal Logs
                    </button>
                    <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/restart"
                        hx-confirm="Restart service on this node?"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-orange-500 hover:bg-orange-500/10 transition-colors text-left">
                        <i data-lucide="rotate-ccw" class="w-4 h-4 opacity-50"></i>
                        Restart Service
                    </button>
                    {% endif %}

                    <div class="h-px bg-white/5 mx-2 my-1.5"></div>

                    <button hx-get="{{ admin_path }}/nodes/{{ node.id }}/edit" hx-target="#edit-node-modal-content"
                        hx-swap="innerHTML"
                        hx-on::after-request="document.getElementById('edit-node-modal').showModal()"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-slate-300 hover:bg-white/5 transition-colors text-left">
                        <i data-lucide="edit-3" class="w-4 h-4 opacity-50"></i>
                        Edit Details
                    </button>
                    <button onclick="showConfigPreview({{ node.id }})"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-slate-300 hover:bg-white/5 transition-colors text-left">
                        <i data-lucide="eye" class="w-4 h-4 opacity-50"></i>
                        Preview Sing-box Config
                    </button>
                    <button onclick="confirmDelete({{ node.id }}, '{{ node.name }}', 'node-row-{{ node.id }}')"
                        class="w-full flex items-center gap-3 px-4 py-2.5 text-xs font-semibold text-red-500 hover:bg-red-500/10 transition-colors text-left">
                        <i data-lucide="trash-2" class="w-4 h-4 opacity-50"></i>
                        Delete Permanently
                    </button>
                </div>
            </div>
        </div>
    </td>
</tr>
{% endfor %}