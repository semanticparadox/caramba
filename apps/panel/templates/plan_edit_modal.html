<header>
    <a href="#close" aria-label="Close" class="close" onclick="document.getElementById('edit-plan-modal').close()"></a>
    Edit Plan: {{ plan.name }}
</header>
<form hx-post="{{ admin_path }}/plans/{{ plan.id }}" hx-target="body" hx-swap="none">
    <label for="edit_name">Plan Name</label>
    <input type="text" id="edit_name" name="name" value="{{ plan.name }}" required>

    <label for="edit_description">Description</label>
    <textarea id="edit_description" name="description"
        required>{{ plan.description.as_deref().unwrap_or("") }}</textarea>

    <label for="edit_device_limit">Device Limit (0 for Unlimited)</label>
    <div class="grid">
        <div>
            <input type="number" id="edit_device_limit" name="device_limit" value="{{ plan.device_limit }}" min="0"
                max="1000" required>
            <small>Max connections</small>
        </div>
        <div>
            <input type="number" id="edit_traffic_limit_gb" name="traffic_limit_gb" style="margin-bottom:0;"
                value="{{ plan.traffic_limit_gb }}" min="0" required>
            <small>Traffic Limit (GB)</small>
        </div>
    </div>

    <label>Available Nodes</label>
    <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        {% for node in nodes %}
        {% let mut is_checked = false %}
        {% for linked_id in linked_node_ids %}
        {% if linked_id == node.id %}
        {% let is_checked = true %}
        {% endif %}
        {% endfor %}
        <label>
            <input type="checkbox" name="node_ids" value="{{ node.id }}" {% if is_checked %}checked{% endif %}>
            {{ node.name }} ({{ node.ip }})
        </label>
        {% endfor %}
        {% if nodes.is_empty() %}
        <small style="color: #ff9800;">No active nodes found. Add a node first.</small>
        {% endif %}
    </div>

    <label>Durations</label>
    <div id="edit-durations-container">
        {% for dur in plan.durations %}
        <div class="duration-row grid">
            <input type="number" name="duration_days" value="{{ dur.duration_days }}" placeholder="Days" min="1"
                required>
            <input type="number" name="price" value="{{ dur.price }}" placeholder="Price (c)" required>
            <button type="button" class="outline contrast" onclick="this.parentElement.remove()">×</button>
        </div>
        {% endfor %}
    </div>
    <button type="button" class="outline secondary" onclick="addEditDurationRow()"
        style="width: 100%; margin-bottom: 1rem;">+ Add Another Duration</button>

    <footer>
        <button type="submit">Save Changes</button>
    </footer>
</form>

<script>
    function addEditDurationRow() {
        const container = document.getElementById('edit-durations-container');
        const row = document.createElement('div');
        row.className = 'duration-row grid';
        row.innerHTML = `
            <input type="number" name="duration_days" placeholder="Days" min="1" required>
            <input type="number" name="price" placeholder="Price (c)" required>
            <button type="button" class="outline contrast" onclick="this.parentElement.remove()">×</button>
        `;
        container.appendChild(row);
    }
</script>