{% extends "base.html" %}

{% block title %}Nodes Management{% endblock %}

{% block content %}
<section>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>VPN Nodes</h2>
        <button onclick="document.getElementById('add-node-modal').showModal()">Add New Node</button>
    </div>

    <table role="grid">
        <thead>
            <tr>
                <th>Name</th>
                <th>IP Address</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody hx-get="{{ admin_path }}/nodes" hx-trigger="every 5s" hx-select="#nodes-table-body"
            hx-target="#nodes-table-body" id="nodes-table-body">
            {% for node in nodes %}
            <tr>
                <td>{{ node.name }}</td>
                <td>
                    {% if node.status == "new" || node.status == "installing" %}
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <small>‚ö° Setup Required</small>
                        <button class="outline" style="font-size: 0.8rem; padding: 0.2rem 0.5rem;"
                            onclick="showConnectModal('{{ node.join_token.clone().unwrap_or_default() }}', '{{ node.name }}')">
                            üîå Connect
                        </button>
                    </div>
                    {% else %}
                    {{ node.ip }}
                    {% endif %}
                </td>
                <td>
                    <span class="badge">
                        {{ node.status|capitalize }}
                    </span>
                </td>
                <td>
                    <div role="group">
                        <a href="{{ admin_path }}/nodes/{{ node.id }}/inbounds" role="button"
                            class="outline">Inbounds</a>

                        {% if node.status == "active" %}
                        <button class="secondary outline" hx-post="{{ admin_path }}/nodes/{{ node.id }}/test"
                            hx-swap="none" hx-on::after-request="alert(event.detail.xhr.responseText)">üîç Test</button>
                        <button class="secondary outline" hx-post="{{ admin_path }}/nodes/{{ node.id }}/restart"
                            hx-swap="none" hx-confirm="Restart sing-box service on this node?"
                            hx-on::after-request="alert(event.detail.xhr.responseText)">üîÑ Restart</button>
                        <button class="outline" hx-get="{{ admin_path }}/nodes/{{ node.id }}/logs"
                            hx-target="#logs-modal-content"
                            hx-on::after-request="document.getElementById('logs-modal').showModal()">üìã Logs</button>
                        <button class="secondary outline" hx-post="{{ admin_path }}/nodes/{{ node.id }}/sync"
                            hx-swap="none"
                            hx-on::after-request="if(event.detail.successful) alert('Sync triggered!')">üì§ Sync</button>
                        {% else %}
                        <!-- Manual install fallback -->
                        <button class="outline" hx-delete="{{ admin_path }}/nodes/{{ node.id }}/delete"
                            hx-confirm="Delete pending node?" hx-target="closest tr" hx-swap="outerHTML">Cancel</button>
                        {% endif %}

                        <button class="outline" hx-get="{{ admin_path }}/nodes/{{ node.id }}/edit"
                            hx-target="#edit-node-modal-content"
                            hx-on::after-request="document.getElementById('edit-node-modal').showModal()">
                            Edit
                        </button>
                        <button class="outline" onclick="showConfigPreview({{ node.id }})">Preview</button>
                        <button class="outline error" hx-delete="{{ admin_path }}/nodes/{{ node.id }}/delete"
                            hx-confirm="Are you sure you want to delete this node? This will remove all associated inbounds."
                            hx-target="closest tr" hx-swap="outerHTML">Delete</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- Add Node Modal -->
<dialog id="add-node-modal">
    <article>
        <header>
            <a href="#close" aria-label="Close" class="close"
                onclick="document.getElementById('add-node-modal').close()"></a>
            Add New VPN Node
        </header>

        <div style="margin-bottom: 1rem;">
            <ul class="grid" style="list-style: none; padding: 0;">
                <li><button class="outline" id="btn-mode-smart" onclick="setMode('smart')">Smart Setup
                        (Recommended)</button></li>
                <li><button class="outline" id="btn-mode-manual" onclick="setMode('manual')">Manual / Advanced</button>
                </li>
            </ul>
        </div>

        <form hx-post="{{ admin_path }}/nodes/install" hx-swap="none">
            <label for="name">Friendly Name</label>
            <input type="text" id="name" name="name" placeholder="Germany-1" required>

            <div id="advanced-fields" style="display: none;">
                <div class="grid">
                    <div>
                        <label for="ip">IP Address</label>
                        <input type="text" id="ip" name="ip" placeholder="1.2.3.4">
                    </div>
                    <div>
                        <label for="port">SSH Port</label>
                        <input type="number" id="port" name="port" placeholder="22" value="22" required>
                    </div>
                </div>
                <div class="grid">
                    <div>
                        <label for="vpn_port">VPN Service Port</label>
                        <input type="number" id="vpn_port" name="vpn_port" placeholder="443" value="443" required>
                    </div>
                    <div><!-- spacer --></div>
                </div>

                <label for="username">SSH Username</label>
                <input type="text" id="username" name="username" placeholder="root" value="root" required>

                <label for="password">Root/User Password (Optional if using Key)</label>
                <input type="password" id="password" name="password">
            </div>

            <!-- Smart Mode Hidden Inputs defaults -->
            <input type="hidden" id="auto_configure" name="auto_configure" value="true">

            <div id="smart-info" style="margin-bottom: 1rem; padding: 1rem; background: #222; border-radius: 8px;">
                <small>
                    1. Enter a Name.<br>
                    2. Click "Generate Command".<br>
                    3. Run the command on your empty VPS.
                </small>
            </div>

            <footer>
                <button type="button" class="secondary"
                    onclick="document.getElementById('add-node-modal').close()">Cancel</button>
                <button type="submit" id="submit-btn"
                    onclick="setTimeout(()=>document.getElementById('add-node-modal').close(), 500)">Generate
                    Command</button>
            </footer>
        </form>
    </article>
</dialog>

<script>
    function setMode(mode) {
        const advanced = document.getElementById('advanced-fields');
        const smart = document.getElementById('smart-info');
        const btnSmart = document.getElementById('btn-mode-smart');
        const btnManual = document.getElementById('btn-mode-manual');
        const submitBtn = document.getElementById('submit-btn');
        const ipInput = document.getElementById('ip');
        const autoConfig = document.getElementById('auto_configure');

        if (mode === 'manual') {
            advanced.style.display = 'block';
            smart.style.display = 'none';
            btnSmart.classList.add('outline');
            btnManual.classList.remove('outline');
            submitBtn.innerText = "Add Node";
            ipInput.required = true;
            autoConfig.value = "false";
        } else {
            advanced.style.display = 'none';
            smart.style.display = 'block';
            btnSmart.classList.remove('outline');
            btnManual.classList.add('outline');
            submitBtn.innerText = "Generate Command";
            ipInput.required = false;
            ipInput.value = "";
            autoConfig.value = "true";
        }
    }
    setMode('smart');
</script>

<!-- Edit Node Modal -->
<dialog id="edit-node-modal">
    <article id="edit-node-modal-content">
        <!-- Content loaded via HTMX -->
        <p aria-busy="true">Loading...</p>
    </article>
</dialog>

<!-- Manual Install Modal -->
<dialog id="manual-install-modal">
    <article id="manual-install-modal-content" style="width: 800px; max-width: 90%;">
        <!-- Content loaded via HTMX -->
        <p aria-busy="true">Loading script...</p>
    </article>
</dialog>

<!-- Config Preview Modal -->
<dialog id="preview-modal">
    <article style="width: 800px; max-width: 90%;">
        <header>
            <a href="#close" aria-label="Close" class="close"
                onclick="document.getElementById('preview-modal').close()"></a>
            Generated Config Preview
        </header>
        <pre id="preview-content"
            style="background: #1a1a1a; padding: 1rem; color: #00ff00; border-radius: 4px; overflow: auto; max-height: 500px;"></pre>
        <footer>
            <button class="outline" onclick="document.getElementById('preview-modal').close()">Close</button>
        </footer>
    </article>
</dialog>

<script>
    async function showConfigPreview(nodeId) {
        const modal = document.getElementById('preview-modal');
        const content = document.getElementById('preview-content');
        content.textContent = "Generating preview...";
        modal.showModal();

        try {
            const resp = await fetch(`/admin/nodes/${nodeId}/config/preview`);
            if (resp.ok) {
                const json = await resp.text();
                content.textContent = json;
            } else {
                content.textContent = "Failed to load preview: " + resp.statusText;
            }
        } catch (e) {
            content.textContent = "Error: " + e;
        }
    }
</script>

<!-- Logs Modal -->
<dialog id="logs-modal">
    <article style="width: 800px; max-width: 90vw;">
        <header>
            <a href="#close" aria-label="Close" class="close"
                onclick="document.getElementById('logs-modal').close()"></a>
            <h3>üóíÔ∏è Node Logs</h3>
        </header>
        <div id="logs-modal-content"
            style="max-height: 500px; overflow-y: auto; background: #f5f5f5; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap;">
            Loading logs...
        </div>
        <footer>
            <button onclick="document.getElementById('logs-modal').close()">Close</button>
        </footer>
    </article>
</dialog>

<!-- Connect Node Modal -->
<dialog id="connect-node-modal">
    <article style="width: 800px; max-width: 90%;">
        <header>
            <a href="#close" aria-label="Close" class="close"
                onclick="document.getElementById('connect-node-modal').close()"></a>
            üîå Connect Node
        </header>

        <p>Run the following command on your <strong><span id="connect-node-name"></span></strong> server:</p>

        <pre><code id="connect-command" style="display: block; background: #222; padding: 1rem; border-radius: 6px; color: #a5d6ff; white-space: pre-wrap; word-break: break-all;">Loading...</code></pre>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button onclick="copyConnectCommand()" id="btn-copy-connect">üìã Copy Command</button>
            <button class="secondary outline"
                onclick="document.getElementById('connect-node-modal').close()">Close</button>
        </div>

        <hr>

        <small style="color: #666;">
            <strong>Troubleshooting:</strong><br>
            ‚Ä¢ Ensure your server is running Debian 12+ or Ubuntu 22.04+<br>
            ‚Ä¢ Ensure ports 80/443 are not blocked<br>
            ‚Ä¢ If you see "Setup Required" after running this, check the logs on the server: `journalctl -u
            exarobot-agent -f`
        </small>
    </article>
</dialog>

<script>
    function showConnectModal(token, name) {
        const modal = document.getElementById('connect-node-modal');
        const cmdBlock = document.getElementById('connect-command');
        const nameSpan = document.getElementById('connect-node-name');

        nameSpan.innerText = name;

        // Construct standard command
        const origin = window.location.origin;
        // Check if we are dev or prod (simple check)
        const cmd = `curl -sSL https://raw.githubusercontent.com/semanticparadox/EXA-ROBOT/main/scripts/install.sh | sudo bash -s -- --role agent --panel "${origin}" --token "${token}"`;

        cmdBlock.innerText = cmd;
        modal.showModal();
    }

    function copyConnectCommand() {
        const cmd = document.getElementById('connect-command').innerText;
        navigator.clipboard.writeText(cmd);
        const btn = document.getElementById('btn-copy-connect');
        const original = btn.innerText;
        btn.innerText = "‚úÖ Copied!";
        setTimeout(() => btn.innerText = original, 2000);
    }
</script>

{% endblock %}