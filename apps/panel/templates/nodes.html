{% extends "base.html" %}

{% block title %}Nodes Management{% endblock %}
{% block header_title %}VPN Nodes{% endblock %}

{% block content %}
<section class="space-y-6">
    <!-- Header Action -->
    <div class="flex justify-end">
        <button onclick="document.getElementById('add-node-modal').showModal()"
            class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 px-4 rounded-lg shadow-lg shadow-indigo-500/20 transition-all hover:scale-[1.02]">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Add New Node</span>
        </button>
    </div>

    <!-- Nodes Table -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl shadow-xl min-h-[400px]">
        <div class="overflow-visible">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5 bg-slate-900/50">
                        <th class="px-6 py-4">Name / IP</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Last Seen</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <!-- Hidden indicator to suppress global loaders -->
                <div id="polling-indicator" class="hidden"></div>
                <tbody hx-get="{{ admin_path }}/nodes" hx-trigger="every 10s, refresh_nodes from:body" hx-target="this"
                    hx-swap="innerHTML" hx-indicator="#polling-indicator" id="nodes-table-body"
                    class="divide-y divide-white/5">
                    {% include "partials/nodes_rows.html" %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Add Node Modal -->
<dialog id="add-node-modal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm">
    <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-lg p-6 m-4 overflow-hidden"
        onclick="event.stopPropagation()">
        <header class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">Add New VPN Node</h3>
            <button onclick="document.getElementById('add-node-modal').close()"
                class="text-slate-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </header>

        <div class="mb-6">
            <div class="flex p-1 bg-slate-950 rounded-xl border border-white/10">
                <button id="btn-mode-smart" onclick="setMode('smart')"
                    class="flex-1 py-2 text-sm font-medium rounded-lg transition-all bg-indigo-600 text-white shadow-lg">
                    Smart Setup
                </button>
                <button id="btn-mode-manual" onclick="setMode('manual')"
                    class="flex-1 py-2 text-sm font-medium rounded-lg text-slate-400 hover:text-white transition-all">
                    Manual
                </button>
            </div>
        </div>

        <form hx-post="{{ admin_path }}/nodes/install" hx-target="#manual-install-modal-content" hx-swap="innerHTML"
            class="space-y-4">
            <div>
                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Friendly
                    Name</label>
                <input type="text" id="name" name="name" placeholder="Germany-1" required
                    class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
            </div>

            <div id="advanced-fields" style="display: none;" class="space-y-4 animate-fade-in">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">IP
                            Address</label>
                        <input type="text" id="ip" name="ip" placeholder="1.2.3.4"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">SSH
                            Port</label>
                        <input type="number" id="port" name="port" placeholder="22" value="22" required
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">VPN
                            Port</label>
                        <input type="number" id="vpn_port" name="vpn_port" placeholder="443" value="443" required
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">SSH
                        Username</label>
                    <input type="text" id="username" name="username" placeholder="root" value="root" required
                        class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Password
                        (Optional)</label>
                    <input type="password" id="password" name="password" placeholder="Root password if no key"
                        class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                </div>
            </div>

            <!-- Smart Mode Hidden defaults -->
            <input type="hidden" id="auto_configure" name="auto_configure" value="true">

            <div id="smart-info" class="p-4 bg-slate-950 border border-white/5 rounded-xl">
                <div class="flex gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-indigo-400 flex-shrink-0"></i>
                    <div class="text-sm text-slate-400 space-y-1">
                        <p>1. Enter a Name.</p>
                        <p>2. Click "Generate Command".</p>
                        <p>3. Run the command on your empty VPS.</p>
                    </div>
                </div>
            </div>

            <div class="pt-4 flex gap-3">
                <button type="button"
                    class="flex-1 py-3.5 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition-colors font-medium"
                    onclick="document.getElementById('add-node-modal').close()">Cancel</button>
                <button type="submit" id="submit-btn"
                    class="flex-[2] bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/20 transition-all hover:scale-[1.02]"
                    onclick="setTimeout(()=>document.getElementById('add-node-modal').close(), 500)">
                    Generate Command
                </button>
            </div>
        </form>
    </div>
</dialog>

<script>
    function setMode(mode) {
        const advanced = document.getElementById('advanced-fields');
        const smart = document.getElementById('smart-info');
        const btnSmart = document.getElementById('btn-mode-smart');
        const btnManual = document.getElementById('btn-mode-manual');
        const submitBtn = document.getElementById('submit-btn');
        const ipInput = document.getElementById('ip');
        const autoConfig = document.getElementById('auto_configure');

        if (mode === 'manual') {
            advanced.style.display = 'block';
            smart.style.display = 'none';
            btnSmart.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
            btnSmart.classList.add('text-slate-400', 'hover:text-white');
            btnManual.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
            btnManual.classList.remove('text-slate-400', 'hover:text-white');

            submitBtn.innerText = "Add Node";
            ipInput.required = true;
            autoConfig.value = "false";
        } else {
            advanced.style.display = 'none';
            smart.style.display = 'block';
            btnSmart.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');
            btnSmart.classList.remove('text-slate-400', 'hover:text-white');
            btnManual.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
            btnManual.classList.add('text-slate-400', 'hover:text-white');

            submitBtn.innerText = "Generate Command";
            ipInput.required = false;
            ipInput.value = "";
            autoConfig.value = "true";
        }
    }
    setMode('smart');
</script>

<!-- Edit Node Modal -->
<dialog id="edit-node-modal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm">
    <div id="edit-node-modal-content"
        class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-lg p-6 m-4 overflow-hidden"
        onclick="event.stopPropagation()">
        <!-- Content loaded via HTMX -->
        <div class="flex items-center justify-center p-12 text-slate-500">
            <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-3"></i> Loading...
        </div>
    </div>
</dialog>

<!-- Manual Install Modal -->
<dialog id="manual-install-modal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm">
    <div id="manual-install-modal-content"
        class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-4xl p-6 m-4 overflow-hidden"
        onclick="event.stopPropagation()">
        <!-- Content loaded via HTMX -->
        <div class="flex items-center justify-center p-12 text-slate-500">
            <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-3"></i> Loading script...
        </div>
    </div>
</dialog>

<!-- Config Preview Modal -->
<dialog id="preview-modal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm">
    <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-4xl p-6 m-4 flex flex-col max-h-[90vh]"
        onclick="event.stopPropagation()">
        <header class="flex justify-between items-center mb-6 flex-shrink-0">
            <h3 class="text-xl font-bold text-white">Generated Config Preview</h3>
            <button onclick="document.getElementById('preview-modal').close()"
                class="text-slate-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </header>

        <div class="flex-1 overflow-auto no-scrollbar bg-[#0a0a0a] rounded-xl border border-white/5 p-4">
            <pre id="preview-content"
                class="text-emerald-400 font-mono text-xs leading-relaxed whitespace-pre-wrap font-fira"></pre>
        </div>

        <footer class="mt-6 flex justify-end flex-shrink-0">
            <button
                class="px-6 py-2.5 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition-colors font-medium"
                onclick="document.getElementById('preview-modal').close()">Close</button>
        </footer>
    </div>
</dialog>

<script>
    async function showConfigPreview(nodeId) {
        const modal = document.getElementById('preview-modal');
        const content = document.getElementById('preview-content');
        content.textContent = "Generating preview...";
        modal.showModal();

        try {
            const resp = await fetch(`{{ admin_path }}/nodes/${nodeId}/config/preview`);
            if (resp.ok) {
                const json = await resp.text();
                // Beautify if JSON
                try {
                    const obj = JSON.parse(json);
                    content.textContent = JSON.stringify(obj, null, 2);
                } catch (e) {
                    content.textContent = json;
                }

            } else {
                content.textContent = "Failed to load preview: " + resp.statusText;
            }
        } catch (e) {
            content.textContent = "Error: " + e;
        }
    }
</script>

<!-- Logs Modal -->
<dialog id="logs-modal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm">
    <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-5xl p-6 m-4 flex flex-col max-h-[90vh] overflow-hidden"
        onclick="event.stopPropagation()">
        <header class="flex justify-between items-center mb-6 flex-shrink-0">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-indigo-400"></i> Node Logs
            </h3>
            <button onclick="document.getElementById('logs-modal').close()"
                class="text-slate-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </header>

        <div id="logs-modal-content"
            class="flex-1 overflow-auto no-scrollbar bg-[#0a0a0a] rounded-xl border border-white/5 p-4 font-mono text-xs text-slate-300 whitespace-pre-wrap leading-relaxed">
            Loading logs...
        </div>

        <footer class="mt-6 flex justify-end flex-shrink-0">
            <button
                class="px-6 py-2.5 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition-colors font-medium"
                onclick="document.getElementById('logs-modal').close()">Close</button>
        </footer>
    </div>
</dialog>

<!-- Connect Node Modal -->
<dialog id="connect-node-modal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm">
    <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-3xl p-6 m-4"
        onclick="event.stopPropagation()">
        <header class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                <i data-lucide="plug" class="w-5 h-5 text-indigo-400"></i> Connect Node
            </h3>
            <button onclick="document.getElementById('connect-node-modal').close()"
                class="text-slate-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </header>

        <p class="text-slate-300 mb-4">Run the following command on your <strong><span id="connect-node-name"
                    class="text-white font-bold"></span></strong> server:</p>

        <div class="bg-[#0a0a0a] rounded-xl border border-white/10 p-4 relative group">
            <code id="connect-command" class="block font-mono text-sm text-indigo-300 break-all pr-12">Loading...</code>
            <button onclick="copyConnectCommand()" id="btn-copy-connect"
                class="absolute top-2 right-2 p-2 bg-white/10 hover:bg-white/20 rounded-lg text-slate-300 transition-colors"
                title="Copy">
                <i data-lucide="copy" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="flex justify-end mt-6">
            <button
                class="px-6 py-2.5 rounded-xl border border-white/10 text-slate-300 hover:bg-white/5 transition-colors font-medium"
                onclick="document.getElementById('connect-node-modal').close()">Close</button>
        </div>

        <div class="mt-6 pt-6 border-t border-white/5">
            <div class="flex gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-amber-500/80 flex-shrink-0"></i>
                <div class="text-xs text-slate-500 space-y-1">
                    <p class="font-bold text-slate-400">Troubleshooting:</p>
                    <p>• Ensure your server is running Debian 12+ or Ubuntu 22.04+</p>
                    <p>• Ensure ports 80/443 are not blocked</p>
                    <p>• If you see "Setup Required" after running this, check the logs on the server: <code
                            class="bg-white/10 px-1 py-0.5 rounded text-slate-400">journalctl -u exarobot-agent -f</code>
                    </p>
                </div>
            </div>
        </div>
    </div>
</dialog>

<script>
    function showConnectModal(token, name) {
        const modal = document.getElementById('connect-node-modal');
        const cmdBlock = document.getElementById('connect-command');
        const nameSpan = document.getElementById('connect-node-name');

        nameSpan.innerText = name;

        // Construct standard command
        const origin = window.location.origin;
        const cmd = `curl -sSL https://raw.githubusercontent.com/semanticparadox/EXA-ROBOT/main/scripts/install.sh | sudo bash -s -- --role agent --panel "${origin}" --token "${token}"`;

        cmdBlock.innerText = cmd;
        modal.showModal();
    }

    function copyConnectCommand() {
        const cmd = document.getElementById('connect-command').innerText;
        navigator.clipboard.writeText(cmd);
        const btn = document.getElementById('btn-copy-connect');

        btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-emerald-400"></i>';
        setTimeout(() => {
            btn.innerHTML = '<i data-lucide="copy" class="w-4 h-4"></i>';
        }, 2000);

        showToast("Command copied to clipboard");
    }
</script>
{% endblock %}