{% extends "base.html" %}

{% block title %}Nodes Management{% endblock %}
{% block header_title %}VPN Nodes{% endblock %}

{% block content %}
<section class="space-y-6">
    <!-- Header Action -->
    <div class="flex justify-end">
        <button onclick="document.getElementById('add-node-modal').showModal()"
            class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 px-4 rounded-lg shadow-lg shadow-indigo-500/20 transition-all hover:scale-[1.02]">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Add New Node</span>
        </button>
    </div>

    <!-- Nodes Table -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl shadow-xl min-h-[400px]">
        <div class="overflow-visible">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5 bg-slate-900/50">
                        <th class="px-6 py-4">Name / IP</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Stats</th>
                        <th class="px-6 py-4">Last Seen</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <!-- Hidden indicator to suppress global loaders -->
                <div id="polling-indicator" class="hidden"></div>
                <tbody hx-get="{{ admin_path }}/nodes" hx-trigger="every 10s, refresh_nodes from:body" hx-target="this"
                    hx-swap="innerHTML" hx-indicator="#polling-indicator" id="nodes-table-body"
                    class="divide-y divide-white/5">
                    {% include "partials/nodes_rows.html" %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Add Node Modal -->
<dialog id="add-node-modal">
    <div class="modal-container" onclick="event.stopPropagation()">
        <header class="modal-header">
            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                <i data-lucide="server" class="w-6 h-6 text-indigo-400"></i>
                Add New VPN Node
            </h3>
            <button onclick="document.getElementById('add-node-modal').close()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <form hx-post="{{ admin_path }}/nodes/install" hx-target="#manual-install-modal-content" hx-swap="innerHTML">
            <div class="modal-body space-y-6">
                <!-- Setup Mode Switcher -->
                <div class="flex p-1.5 bg-slate-950 rounded-2xl border border-white/5 shadow-inner">
                    <button type="button" id="btn-mode-smart" onclick="setMode('smart')"
                        class="flex-1 py-2.5 text-xs font-bold rounded-xl transition-all bg-indigo-600 text-white shadow-lg border border-white/10">
                        Smart Setup
                    </button>
                    <button type="button" id="btn-mode-manual" onclick="setMode('manual')"
                        class="flex-1 py-2.5 text-xs font-bold rounded-xl text-slate-500 hover:text-slate-300 transition-all">
                        Manual Mode
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Friendly
                            Name</label>
                        <input type="text" id="name" name="name" placeholder="Germany-1" required class="input-field">
                    </div>

                    <div id="advanced-fields" style="display: none;" class="space-y-4 animate-fade-in fade-in">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">IP
                                    Address</label>
                                <input type="text" id="ip" name="ip" placeholder="1.2.3.4" class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">SSH
                                    Port</label>
                                <input type="number" id="port" name="port" placeholder="22" value="22" required
                                    class="input-field">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">VPN
                                    Port</label>
                                <input type="number" id="vpn_port" name="vpn_port" placeholder="443" value="443"
                                    required class="input-field">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">SSH
                                    Username</label>
                                <input type="text" id="username" name="username" placeholder="root" value="root"
                                    required class="input-field">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">SSH
                                Password (Optional)</label>
                            <input type="password" id="password" name="password"
                                placeholder="Root password if no SSH keys" class="input-field">
                        </div>
                    </div>

                    <input type="hidden" id="auto_configure" name="auto_configure" value="true">

                    <div id="smart-info" class="p-4 bg-indigo-500/5 border border-indigo-500/10 rounded-2xl">
                        <div class="flex gap-4">
                            <div
                                class="w-10 h-10 rounded-full bg-indigo-500/10 flex items-center justify-center text-indigo-400 shrink-0">
                                <i data-lucide="terminal" class="w-5 h-5"></i>
                            </div>
                            <div class="text-xs text-slate-400 space-y-2 leading-relaxed">
                                <p class="font-bold text-slate-300">Quick Installation Flow:</p>
                                <p>• Enter a friendly name for identification</p>
                                <p>• Generate the one-line install command</p>
                                <p>• Paste it into your SSH terminal and wait ~1 min</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="modal-footer">
                <button type="button" class="btn-secondary"
                    onclick="document.getElementById('add-node-modal').close()">Cancel</button>
                <button type="submit" id="submit-btn" class="btn-primary"
                    onclick="setTimeout(()=>document.getElementById('add-node-modal').close(), 500)">
                    Generate Command
                </button>
            </footer>
        </form>
    </div>
</dialog>

<script>
    function setMode(mode) {
        const advanced = document.getElementById('advanced-fields');
        const smart = document.getElementById('smart-info');
        const btnSmart = document.getElementById('btn-mode-smart');
        const btnManual = document.getElementById('btn-mode-manual');
        const submitBtn = document.getElementById('submit-btn');
        const ipInput = document.getElementById('ip');
        const autoConfig = document.getElementById('auto_configure');

        const activeClasses = ['bg-indigo-600', 'text-white', 'shadow-lg', 'border', 'border-white/10'];
        const inactiveClasses = ['text-slate-500', 'hover:text-slate-300'];

        if (mode === 'manual') {
            advanced.style.display = 'block';
            smart.style.display = 'none';
            btnSmart.classList.remove(...activeClasses);
            btnSmart.classList.add(...inactiveClasses);
            btnManual.classList.add(...activeClasses);
            btnManual.classList.remove(...inactiveClasses);

            submitBtn.innerText = "Add Node";
            ipInput.required = true;
            autoConfig.value = "false";
        } else {
            advanced.style.display = 'none';
            smart.style.display = 'block';
            btnSmart.classList.add(...activeClasses);
            btnSmart.classList.remove(...inactiveClasses);
            btnManual.classList.remove(...activeClasses);
            btnManual.classList.add(...inactiveClasses);

            submitBtn.innerText = "Generate Command";
            ipInput.required = false;
            ipInput.value = "";
            autoConfig.value = "true";
        }
    }
    setMode('smart');
</script>

<!-- Edit Node Modal -->
<dialog id="edit-node-modal">
    <div id="edit-node-modal-content" class="modal-container" onclick="event.stopPropagation()">
        <!-- Content loaded via HTMX -->
        <div class="flex items-center justify-center p-20 text-slate-500">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mr-3"></i>
            <span class="font-medium">Loading...</span>
        </div>
    </div>
</dialog>

<!-- Manual Install Modal -->
<dialog id="manual-install-modal">
    <div id="manual-install-modal-content" class="modal-container max-w-4xl" onclick="event.stopPropagation()">
        <!-- Content loaded via HTMX -->
        <div class="flex items-center justify-center p-20 text-slate-500">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin mr-3"></i>
            <span class="font-medium">Loading script...</span>
        </div>
    </div>
</dialog>

<!-- Config Preview Modal -->
<dialog id="preview-modal">
    <div class="modal-container max-w-4xl" onclick="event.stopPropagation()">
        <header class="modal-header">
            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                <i data-lucide="code" class="w-6 h-6 text-emerald-400"></i>
                Generated Config Preview
            </h3>
            <button onclick="document.getElementById('preview-modal').close()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <div class="modal-body bg-[#0a0a0a] !p-0">
            <pre id="preview-content"
                class="text-emerald-400 font-mono text-xs leading-relaxed p-6 whitespace-pre-wrap font-fira bg-[#0a0a0a] min-h-[400px]"></pre>
        </div>

        <footer class="modal-footer">
            <button class="btn-secondary" onclick="document.getElementById('preview-modal').close()">Close
                Preview</button>
        </footer>
    </div>
</dialog>

<script>
    async function showConfigPreview(nodeId) {
        const modal = document.getElementById('preview-modal');
        const content = document.getElementById('preview-content');
        content.textContent = "Generating preview...";
        modal.showModal();

        try {
            const resp = await fetch(`{{ admin_path }}/nodes/${nodeId}/config/preview`);
            if (resp.ok) {
                const json = await resp.text();
                // Beautify if JSON
                try {
                    const obj = JSON.parse(json);
                    content.textContent = JSON.stringify(obj, null, 2);
                } catch (e) {
                    content.textContent = json;
                }

            } else {
                content.textContent = "Failed to load preview: " + resp.statusText;
            }
        } catch (e) {
            content.textContent = "Error: " + e;
        }
    }
</script>

<!-- Logs Modal -->
<dialog id="logs-modal">
    <div class="modal-container max-w-5xl" onclick="event.stopPropagation()">
        <header class="modal-header">
            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                <i data-lucide="terminal" class="w-6 h-6 text-indigo-400"></i>
                Node Terminal Logs
            </h3>
            <button onclick="document.getElementById('logs-modal').close()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <div id="logs-modal-content"
            class="modal-body bg-[#0a0a0a] font-mono text-xs text-slate-400 whitespace-pre-wrap leading-relaxed min-h-[500px]">
            <div class="flex items-center justify-center h-full text-slate-600 italic">
                Fetching logs from remote node...
            </div>
        </div>

        <footer class="modal-footer">
            <button class="btn-secondary" onclick="document.getElementById('logs-modal').close()">Close Console</button>
        </footer>
    </div>
</dialog>

<!-- Connect Node Modal -->
<dialog id="connect-node-modal">
    <div class="modal-container" onclick="event.stopPropagation()">
        <header class="modal-header">
            <h3 class="text-xl font-bold text-white flex items-center gap-3">
                <i data-lucide="terminal" class="w-6 h-6 text-indigo-400"></i>
                Manual Setup: <span id="connect-node-name" class="text-indigo-400 font-mono text-base"></span>
            </h3>
            <button onclick="document.getElementById('connect-node-modal').close()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <div class="modal-body space-y-6">
            <div class="space-y-3">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest">Quick Installation
                    Command</label>
                <div class="relative group">
                    <div class="absolute inset-0 bg-emerald-500/5 rounded-2xl pointer-events-none"></div>
                    <input type="text" id="connect-command-input" value="Loading command..." readonly
                        class="w-full bg-[#0a0a0a] border border-emerald-500/20 rounded-2xl px-5 py-4 pr-28 text-emerald-400 font-mono text-xs focus:border-emerald-500 outline-none leading-relaxed transition-all">

                    <button onclick="copyConnectCommand()" id="btn-copy-connect"
                        class="absolute right-3 top-3 bottom-3 px-4 bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-400 text-[10px] font-bold uppercase tracking-wider rounded-xl transition-all border border-emerald-500/20 flex items-center gap-2 active:scale-95">
                        <i data-lucide="copy" class="w-3.5 h-3.5"></i> Copy
                    </button>
                </div>
            </div>

            <div class="p-4 rounded-2xl bg-amber-500/5 border border-amber-500/10 space-y-3">
                <div class="flex gap-3">
                    <i data-lucide="info" class="w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5"></i>
                    <p class="text-[11px] font-bold text-amber-500 uppercase tracking-widest">Requirements &
                        Troubleshooting</p>
                </div>
                <ul class="text-[11px] text-slate-500 space-y-1.5 list-disc list-inside px-1">
                    <li>Debian 12+ or Ubuntu 22.04+ (Clean OS recommended)</li>
                    <li>Ensure ports 80 and 443 are open in your VPS firewall</li>
                    <li>Command must be run as <span class="text-slate-400 font-bold">root</span> or via <span
                            class="text-slate-400 font-bold">sudo</span></li>
                    <li>If installation fails, run: <code
                            class="bg-white/5 px-1 rounded text-slate-400">journalctl -u exarobot-agent -f</code></li>
                </ul>
            </div>
        </div>

        <footer class="modal-footer">
            <button class="btn-secondary" onclick="document.getElementById('connect-node-modal').close()">Close
                Window</button>
        </footer>
    </div>
</dialog>

<script>
    function showConnectModal(token, name) {
        const modal = document.getElementById('connect-node-modal');
        const input = document.getElementById('connect-command-input');
        const nameSpan = document.getElementById('connect-node-name');

        nameSpan.innerText = name;

        const origin = window.location.origin;
        const cmd = `curl -sSL https://raw.githubusercontent.com/semanticparadox/EXA-ROBOT/main/scripts/install.sh | sudo bash -s -- --role agent --panel "${origin}" --token "${token}"`;

        input.value = cmd;
        modal.showModal();
        lucide.createIcons();
    }

    function copyConnectCommand() {
        const el = document.getElementById('connect-command-input');
        const val = el.value;
        navigator.clipboard.writeText(val).then(() => {
            const btn = document.getElementById('btn-copy-connect');
            const originalContent = btn.innerHTML;

            btn.innerHTML = '<i data-lucide="check" class="w-3.5 h-3.5"></i> Copied!';
            btn.classList.replace('text-emerald-400', 'text-white');
            btn.classList.replace('bg-emerald-500/10', 'bg-emerald-500');

            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.replace('text-white', 'text-emerald-400');
                btn.classList.replace('bg-emerald-500', 'bg-emerald-500/10');
                lucide.createIcons();
            }, 2000);
            lucide.createIcons();
            showToast("Installation command copied");
        });
    }
</script>
</script>
{% endblock %}