{% extends "base.html" %}

{% block title %}Node Inbounds{% endblock %}
{% block header_title %}Node Inbounds{% endblock %}

{% block content %}
<section class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <i data-lucide="network" class="w-6 h-6 text-indigo-400"></i>
                Manage Inbounds
            </h2>
            <div class="flex items-center gap-2 text-sm text-slate-400 mt-1">
                <span class="font-mono text-indigo-300">{{ node.name }}</span>
                <span class="text-slate-600">•</span>
                <span class="font-mono bg-slate-800 px-1.5 py-0.5 rounded text-xs">{{ node.ip }}</span>
                {% if !groups.is_empty() %}
                <span class="text-slate-600">•</span>
                <div class="flex gap-1.5">
                    {% for group in groups %}
                    <span
                        class="px-2 py-0.5 rounded bg-indigo-500/10 text-indigo-400 text-[10px] font-bold border border-indigo-500/20">
                        {{ group.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/sync" hx-swap="none"
                hx-confirm="Warning: This will DELETE non-templated inbounds and regenerate default ones from templates. Proceed?"
                class="flex items-center gap-2 px-4 py-2 bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 border border-indigo-500/20 rounded-xl text-sm font-medium transition-all group">
                <i data-lucide="refresh-cw"
                    class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                Sync from Templates
            </button>
            <a href="{{ admin_path }}/nodes"
                class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white text-sm font-medium rounded-xl transition-colors border border-white/5">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Nodes
            </a>
        </div>
    </div>

    <!-- Inbounds List -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden shadow-xl">
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-slate-900/30">
            <h3 class="text-lg font-semibold text-white">Active Inbounds</h3>
            <span
                class="px-2.5 py-1 rounded-full text-xs font-medium bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">
                {{ inbounds.len() }} Configured
            </span>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5 bg-slate-900/30">
                        <th class="px-6 py-4">Tag</th>
                        <th class="px-6 py-4">Protocol</th>
                        <th class="px-6 py-4">Port</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for inbound in inbounds %}
                    <tr id="inbound-row-{{ inbound.id }}" class="hover:bg-white/5 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="flex flex-col">
                                <span class="font-medium text-white">
                                    {% if let Some(remark) = inbound.remark %}
                                    {{ remark }}
                                    {% else %}
                                    {{ inbound.tag }}
                                    {% endif %}
                                </span>
                                <span class="text-[10px] text-slate-500 font-mono">
                                    {{ inbound.tag }}
                                    {% if inbound.tag.starts_with("tpl_") %}
                                    • <span class="text-indigo-400">Group Managed</span>
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span
                                class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-slate-800 text-slate-300 border border-white/5 font-mono">
                                {{ inbound.protocol|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-400 font-mono">{{ inbound.listen_port }}</td>
                        <td class="px-6 py-4">
                            {% if inbound.enable %}
                            <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}/toggle"
                                hx-swap="none"
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/20 cursor-pointer transition-colors"
                                title="Click to Disable">
                                Enabled
                            </button>
                            {% else %}
                            <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}/toggle"
                                hx-swap="none"
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-500/10 text-slate-400 border border-slate-500/20 hover:bg-slate-500/20 cursor-pointer transition-colors"
                                title="Click to Enable">
                                Disabled
                            </button>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                {% if inbound.tag.starts_with("tpl_") %}
                                <span class="text-xs text-slate-500 font-medium italic mr-2 flex items-center gap-1">
                                    <i data-lucide="lock" class="w-3 h-3"></i> Managed
                                </span>
                                {% else %}
                                <button
                                    class="p-2 rounded-lg bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 hover:text-indigo-300 transition-colors border border-indigo-500/10"
                                    hx-get="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}"
                                    hx-target="#edit-inbound-modal-content"
                                    hx-on::after-request="document.getElementById('edit-inbound-modal').showModal()">
                                    <i data-lucide="settings-2" class="w-4 h-4"></i>
                                </button>
                                <button
                                    class="p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 transition-colors border border-red-500/10"
                                    hx-delete="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}"
                                    hx-confirm="Delete inbound {{ inbound.tag }}?" hx-target="#inbound-row-{{ inbound.id }}"
                                    hx-swap="outerHTML">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                    {% if inbounds.is_empty() %}
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-slate-800/50 flex items-center justify-center">
                                    <i data-lucide="network" class="w-6 h-6 text-slate-600"></i>
                                </div>
                                <p>No inbounds configured for this node.</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Inbound Modal -->
    <dialog id="edit-inbound-modal"
        class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm z-50">
        <div id="edit-inbound-modal-content"
            class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-center p-12 text-slate-500">
                <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-3"></i> Loading...
            </div>
        </div>
    </dialog>

    <!-- Add Inbound Form -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 sm:p-8">
        <header class="mb-8">
            <h3 class="text-lg font-bold text-white mb-2">Add New Inbound</h3>
            <p class="text-sm text-slate-400">Configure a new proxy inbound protocols for this node.</p>
        </header>

        <form hx-post="{{ admin_path }}/nodes/{{ node.id }}/inbounds" hx-target="body" hx-swap="none" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Basic Info -->
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Remark
                                / Name</label>
                            <input type="text" name="remark" placeholder="e.g. My Custom VLESS"
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Tag
                                (Identifier)</label>
                            <input type="text" name="tag" placeholder="e.g. vless-tcp-reality" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Protocol</label>
                        <div class="relative">
                            <select id="protocol" name="protocol" onchange="updateTemplates()" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none appearance-none">
                                <option value="vless">VLESS Reality (TCP)</option>
                                <option value="shadowsocks">Shadowsocks (TCP)</option>
                                <option value="hysteria2">Hysteria 2</option>
                                <option value="tuic">TUIC v5</option>
                                <option value="naive">NaiveProxy</option>
                                <option value="trojan">Trojan</option>
                            </select>
                            <i data-lucide="chevron-down"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Listen
                                Port</label>
                            <input type="number" name="listen_port" value="443" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none font-mono">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Listen
                                IP</label>
                            <input type="text" name="listen_ip" value="::" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none font-mono">
                        </div>
                    </div>

                    <!-- SNI Helper -->
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Server
                            Name (SNI) / Dest</label>
                        <input type="text" id="sni_input" placeholder="e.g. drive.google.com"
                            oninput="updateSniFromJson()"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none">
                        <p class="text-[10px] text-slate-500 mt-1.5 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i> Auto-updates JSON settings below
                        </p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                <!-- Protocol Settings -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider">Protocol
                            Settings</label>
                        <span class="text-[10px] text-slate-500 font-mono">JSON</span>
                    </div>
                    <textarea id="settings" name="settings" rows="8"
                        class="w-full bg-[#0d1117] border border-white/10 rounded-xl p-4 text-sm text-emerald-400 font-mono focus:border-indigo-500 outline-none transition-all leading-relaxed resize-y custom-scrollbar">{}</textarea>
                </div>

                <!-- Stream Settings -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider">Stream
                            Settings</label>
                        <span class="text-[10px] text-slate-500 font-mono">JSON</span>
                    </div>
                    <textarea id="stream_settings" name="stream_settings" rows="8" oninput="syncSniInput()"
                        class="w-full bg-[#0d1117] border border-white/10 rounded-xl p-4 text-sm text-emerald-400 font-mono focus:border-indigo-500 outline-none transition-all leading-relaxed resize-y custom-scrollbar">{}</textarea>
                </div>
            </div>

            <div class="pt-6 border-t border-white/5 flex justify-end">
                <button type="submit"
                    class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 px-8 rounded-xl shadow-lg shadow-indigo-500/20 transition-all hover:scale-[1.02]">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span>Add Inbound Configuration</span>
                </button>
            </div>
        </form>
    </div>
</section>

<script>
    const templates = {
        vless: {
            settings: {
                "clients": [{
                    "id": "",
                    "flow": "xtls-rprx-vision",
                    "email": "user@example.com"
                }],
                "decryption": "none",
                "fallbacks": []
            },
            stream_settings: {
                "network": "tcp",
                "security": "reality",
                "reality_settings": {
                    "show": false,
                    "dest": "drive.google.com:443",
                    "xver": 0,
                    "server_names": ["drive.google.com"],
                    "private_key": "",
                    "short_ids": [""]
                }
            }
        },
        shadowsocks: {
            settings: {
                "method": "2022-blake3-aes-128-gcm",
                "users": []
            },
            stream_settings: {
                "network": "tcp"
            }
        },
        hysteria2: {
            settings: {
                "users": [{ "password": "" }],
                "up_mbps": 100,
                "down_mbps": 100,
                "ignore_client_bandwidth": false
            },
            stream_settings: {
                "network": "udp",
                "security": "tls",
                "tls_settings": {
                    "server_name": "drive.google.com",
                    "certificates": []
                },
                "masquerade": "https://www.google.com"
            }
        },
        trojan: {
            settings: {
                "clients": [{ "password": "" }],
                "fallback": null
            },
            stream_settings: {
                "network": "tcp",
                "security": "tls",
                "tls_settings": {
                    "server_name": "drive.google.com",
                    "certificates": []
                }
            }
        },
        tuic: {
            settings: {
                "users": [{ "uuid": "", "password": "" }],
                "congestion_control": "bbr",
                "auth_timeout": "3s",
                "zero_rtt_handshake": true,
                "heartbeat": "10s"
            },
            stream_settings: {
                "network": "udp",
                "security": "tls",
                "tls_settings": {
                    "server_name": "drive.google.com",
                    "certificates": [],
                    "alpn": ["h3"]
                }
            }
        },
        naive: {
            settings: {
                "users": [{ "username": "admin", "password": "" }]
            },
            stream_settings: {
                "network": "tcp",
                "security": "tls",
                "tls_settings": {
                    "server_name": "drive.google.com",
                    "certificates": []
                }
            }
        }
    };

    function updateTemplates() {
        const protocol = document.getElementById('protocol').value;
        const tmpl = templates[protocol];
        if (tmpl) {
            document.getElementById('settings').value = JSON.stringify(tmpl.settings, null, 4);
            document.getElementById('stream_settings').value = JSON.stringify(tmpl.stream_settings, null, 4);
            syncSniInput();
        }
    }

    function syncSniInput() {
        try {
            const json = JSON.parse(document.getElementById('stream_settings').value);
            let sni = "";
            if (json.reality_settings && json.reality_settings.server_names && json.reality_settings.server_names.length > 0) {
                sni = json.reality_settings.server_names[0];
            } else if (json.tls_settings && json.tls_settings.server_name) {
                sni = json.tls_settings.server_name;
            }
            if (sni) document.getElementById('sni_input').value = sni;
        } catch (e) { }
    }

    function updateSniFromJson() {
        const sni = document.getElementById('sni_input').value;
        try {
            const json = JSON.parse(document.getElementById('stream_settings').value);
            if (json.reality_settings) {
                json.reality_settings.server_names = [sni];
                if (json.reality_settings.dest && json.reality_settings.dest.includes(":")) {
                    json.reality_settings.dest = sni + ":443";
                }
            } else if (json.tls_settings) {
                json.tls_settings.server_name = sni;
            } else {
                if (!json.tls_settings) json.tls_settings = {};
                json.tls_settings.server_name = sni;
            }
            document.getElementById('stream_settings').value = JSON.stringify(json, null, 4);
        } catch (e) { }
    }

    updateTemplates();
</script>
{% endblock %}