<dialog id="editTemplateModal" open>
    <div class="modal-container max-w-2xl" onclick="event.stopPropagation()">
        <header class="modal-header">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-400">
                    <i data-lucide="file-json" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Edit Inbound Template</h3>
            </div>
            <button onclick="document.getElementById('editTemplateModal').remove()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <form action="{{ admin_path }}/templates/{{ tpl.id }}" method="POST">
            <div class="modal-body space-y-6">
                <!-- Row 1: Name & Group -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Template
                            Name</label>
                        <input type="text" name="name" value="{{ tpl.name }}" required class="input-field">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Target
                            Group</label>
                        <div class="relative">
                            <select name="target_group_id" class="input-field appearance-none">
                                <option value="">-- All Groups --</option>
                                {% for g in groups %}
                                <option value="{{ g.id }}" {% if g.id==tpl.target_group_id.unwrap_or(0) %}selected{%
                                    endif %}>{{ g.name }}</option>
                                {% endfor %}
                            </select>
                            <i data-lucide="chevron-down"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <!-- Row 2: Protocol & Ports -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label
                            class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Protocol</label>
                        <div class="relative">
                            <select name="protocol" class="input-field appearance-none">
                                <option value="vless" {% if tpl.protocol=="vless" %}selected{% endif %}>VLESS</option>
                                <option value="vmess" {% if tpl.protocol=="vmess" %}selected{% endif %}>VMess</option>
                                <option value="trojan" {% if tpl.protocol=="trojan" %}selected{% endif %}>Trojan
                                </option>
                                <option value="shadowsocks" {% if tpl.protocol=="shadowsocks" %}selected{% endif %}>
                                    Shadowsocks</option>
                                <option value="hysteria2" {% if tpl.protocol=="hysteria2" %}selected{% endif %}>
                                    Hysteria2</option>
                                <option value="tuic" {% if tpl.protocol=="tuic" %}selected{% endif %}>TUIC v5</option>
                                <option value="naive" {% if tpl.protocol=="naive" %}selected{% endif %}>NaiveProxy
                                </option>
                            </select>
                            <i data-lucide="chevron-down"
                                class="absolute right-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none"></i>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Port
                            Start</label>
                        <input type="number" name="port_range_start" value="{{ tpl.port_range_start }}" required
                            class="input-field font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Port
                            End</label>
                        <input type="number" name="port_range_end" value="{{ tpl.port_range_end }}" required
                            class="input-field font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Rotation
                            (Mins)</label>
                        <input type="number" name="renew_interval_mins" value="{{ tpl.renew_interval_mins }}" required
                            class="input-field font-mono" title="0 = no automatic rotation">
                    </div>
                </div>

                {% let template = Some(tpl) %}
                <!-- Visual Editor Partial -->
                {% include "partials/visual_editor.html" %}

                <script>
                    (function () {
                        const form = document.currentScript.closest('form');
                        if (form && window.VisualEditor) {
                            new VisualEditor(form);
                        }
                    })();
                </script>
            </div>

            <footer class="modal-footer">
                <button type="button" class="btn-secondary"
                    onclick="document.getElementById('editTemplateModal').remove()">Cancel</button>
                <button type="submit" class="btn-primary">
                    <i data-lucide="save" class="w-4 h-4 mr-2 inline-block"></i>Save Template Changes
                </button>
            </footer>
        </form>
    </div>
</dialog>