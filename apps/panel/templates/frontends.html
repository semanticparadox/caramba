{% extends "base.html" %}

{% block title %}Frontend Servers - EXA-ROBOT{% endblock %}
{% block header_title %}Frontend Servers{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header & Actions -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h2 class="text-xl font-bold text-white tracking-tight">Frontend Nodes</h2>
            <p class="text-slate-400 text-sm mt-1">Manage distributed servers for resilience and load balancing.</p>
        </div>
        <button onclick="document.getElementById('addFrontendModal').showModal()"
            class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2.5 px-5 rounded-xl transition-all shadow-[0_0_20px_rgba(255,107,53,0.3)] hover:shadow-[0_0_30px_rgba(255,107,53,0.5)] border border-white/10">
            <i data-lucide="plus-circle" class="w-5 h-5"></i>
            <span>Add Frontend</span>
        </button>
    </div>

    <!-- Frontend Servers List -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden glass">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5 bg-slate-900/30">
                        <th class="px-6 py-4">Domain</th>
                        <th class="px-6 py-4">Region</th>
                        <th class="px-6 py-4">IP Address</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Traffic (Mo)</th>
                        <th class="px-6 py-4">Last Seen</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="frontendsTableBody" class="divide-y divide-white/5 text-sm">
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-slate-400">
                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-3 animate-spin text-indigo-500"></i>
                            <p>Loading servers...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Frontend Modal -->
<dialog id="addFrontendModal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm z-50">
    <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-lg p-6 m-4 ring-1 ring-white/10"
        onclick="event.stopPropagation()">
        <header class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-400">
                    <i data-lucide="globe" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Add Frontend</h3>
            </div>
            <button onclick="document.getElementById('addFrontendModal').close()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <form id="addFrontendForm" class="space-y-5">
            <div>
                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Domain</label>
                <div class="relative">
                    <i data-lucide="link" class="absolute left-4 top-3.5 w-4 h-4 text-slate-500"></i>
                    <input type="text" name="domain" placeholder="frontend-eu.example.com" required
                        class="w-full bg-slate-950 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <p class="text-[10px] text-slate-500 mt-1.5 ml-1">Must be a valid FQDN pointing to the server IP.</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">IP
                        Address</label>
                    <div class="relative">
                        <i data-lucide="network" class="absolute left-4 top-3.5 w-4 h-4 text-slate-500"></i>
                        <input type="text" name="ip_address" placeholder="1.2.3.4" required
                            class="w-full bg-slate-950 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                </div>
                <div>
                    <label
                        class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Region</label>
                    <div class="relative">
                        <i data-lucide="map-pin" class="absolute left-4 top-3.5 w-4 h-4 text-slate-500"></i>
                        <select name="region" required
                            class="w-full bg-slate-950 border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all appearance-none">
                            <option value="" disabled selected>Select...</option>
                            <option value="eu">Europe</option>
                            <option value="us">USA</option>
                            <option value="asia">Asia</option>
                            <option value="other">Other</option>
                        </select>
                        <i data-lucide="chevron-down"
                            class="absolute right-4 top-3.5 w-4 h-4 text-slate-500 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="pt-4">
                <button type="submit" id="createFrontendBtn"
                    class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-indigo-600 to-indigo-500 hover:from-indigo-500 hover:to-indigo-400 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-500/20 transition-all hover:scale-[1.02]">
                    <span>Deploy & Generate Command</span>
                    <i data-lucide="arrow-right" class="w-5 h-5"></i>
                </button>
            </div>
        </form>
    </div>
</dialog>

<!-- Install Command Modal -->
<dialog id="installCommandModal"
    class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm z-50">
    <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-2xl p-6 m-4 ring-1 ring-emerald-500/30"
        onclick="event.stopPropagation()">
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-400">
                    <i data-lucide="check-circle-2" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-bold text-white">Frontend Created!</h3>
            </div>
            <button onclick="document.getElementById('installCommandModal').close()"
                class="text-slate-400 hover:text-white transition-colors p-2 hover:bg-white/5 rounded-lg">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <div class="space-y-6">
            <div class="bg-emerald-500/5 border border-emerald-500/20 rounded-xl p-4 flex gap-3">
                <i data-lucide="info" class="w-5 h-5 text-emerald-400 flex-shrink-0 mt-0.5"></i>
                <div class="text-sm text-emerald-100/80">
                    <p class="font-medium text-emerald-400 mb-1">Installation Required</p>
                    Run the command below on your server to install the frontend service. This token is shown only once.
                </div>
            </div>

            <div class="relative group">
                <pre id="installCommand"
                    class="bg-slate-950 border border-white/5 rounded-xl p-5 text-emerald-400 font-mono text-xs overflow-x-auto whitespace-pre-wrap break-all leading-relaxed shadow-inner"></pre>
                <button id="copyInstallCmd"
                    class="absolute top-3 right-3 p-2 bg-white/5 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="space-y-3">
                <h4 class="text-sm font-semibold text-white uppercase tracking-wider">Instructions</h4>
                <ol class="space-y-3 text-sm text-slate-400 list-decimal list-outside ml-4">
                    <li>SSH into your server: <code
                            class="text-indigo-400 font-mono bg-white/5 px-1.5 py-0.5 rounded">ssh root@<span id="serverIP"></span></code>
                    </li>
                    <li>Paste and run the installation command above</li>
                    <li>Wait ~2 minutes for the setup to complete</li>
                    <li>Verify by visiting: <a href="#" id="verifyLink" target="_blank"
                            class="text-indigo-400 hover:text-indigo-300 underline underline-offset-4 decoration-indigo-500/30">https://<span
                                id="serverDomain"></span>/health</a></li>
                </ol>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-white/5 flex justify-end">
            <button onclick="document.getElementById('installCommandModal').close()"
                class="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 text-white font-medium rounded-xl transition-colors">
                Done
            </button>
        </div>
    </div>
</dialog>

<script>
    // Load frontends
    async function loadFrontends() {
        try {
            const response = await fetch('/api/admin/frontends');
            const frontends = await response.json();

            const tbody = document.getElementById('frontendsTableBody');

            if (frontends.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-16 text-center text-slate-500">
                        <div class="flex flex-col items-center justify-center">
                            <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4">
                                <i data-lucide="server-off" class="w-8 h-8 text-slate-600"></i>
                            </div>
                            <p class="text-base font-medium text-white mb-1">No Frontend Servers</p>
                            <p class="text-sm">Click the button above to deploy your first distributed node.</p>
                        </div>
                    </td>
                </tr>
            `;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = frontends.map(f => `
            <tr class="hover:bg-white/5 transition-colors group">
                <td class="px-6 py-4">
                    <a href="https://${f.domain}" target="_blank" class="flex items-center gap-2 text-white font-medium hover:text-indigo-400 transition-colors">
                        ${f.domain} <i data-lucide="external-link" class="w-3.5 h-3.5 opacity-50"></i>
                    </a>
                </td>
                <td class="px-6 py-4">
                    <span class="px-2.5 py-1 rounded-md text-xs font-medium border border-white/10 bg-slate-800 text-slate-300 uppercase">${f.region}</span>
                </td>
                <td class="px-6 py-4">
                    <code class="text-xs font-mono text-slate-400 bg-white/5 px-1.5 py-0.5 rounded border border-white/5 select-all">${f.ip_address}</code>
                </td>
                <td class="px-6 py-4">
                    ${f.is_active ?
                    '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>Active</span>' :
                    '<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-rose-500/10 text-rose-400 border border-rose-500/20"><span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span>Inactive</span>'}
                </td>
                <td class="px-6 py-4 text-slate-300">${formatBytes(f.traffic_monthly || 0)}</td>
                <td class="px-6 py-4">
                    ${f.last_heartbeat ?
                    `<span class="text-slate-400 text-xs">${timeAgo(f.last_heartbeat)}</span>` :
                    '<span class="text-amber-500/80 text-xs">Never</span>'}
                </td>
                <td class="px-6 py-4 text-right">
                    <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button title="Test Health" onclick="testFrontend('${f.domain}')" class="p-2 hover:bg-emerald-500/10 text-slate-400 hover:text-emerald-400 rounded-lg transition-colors">
                            <i data-lucide="activity" class="w-4 h-4"></i>
                        </button>
                        <button title="Rotate Token" onclick="rotateToken(${f.id})" class="p-2 hover:bg-amber-500/10 text-slate-400 hover:text-amber-400 rounded-lg transition-colors">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                        <button title="Delete" onclick="deleteFrontend(${f.id}, '${f.domain}')" class="p-2 hover:bg-rose-500/10 text-slate-400 hover:text-rose-400 rounded-lg transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

            lucide.createIcons();

        } catch (error) {
            console.error('Failed to load frontends:', error);
            document.getElementById('frontendsTableBody').innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-8 text-center text-rose-400 bg-rose-500/5">
                    <p class="font-medium">Failed to load data</p>
                    <p class="text-xs opacity-80 mt-1">${error.message}</p>
                </td>
            </tr>
        `;
        }
    }

    // Create frontend
    document.getElementById('addFrontendForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('createFrontendBtn');
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Loading state
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Provisioning...</span>';
        lucide.createIcons();

        try {
            const response = await fetch('/api/admin/frontends', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(await response.text() || 'Failed to create frontend');

            const result = await response.json();

            // Hide add modal
            document.getElementById('addFrontendModal').close();

            // Show install command modal
            document.getElementById('installCommand').textContent = result.install_command;
            document.getElementById('serverIP').textContent = data.ip_address;
            document.getElementById('serverDomain').textContent = data.domain;
            document.getElementById('verifyLink').href = `https://${data.domain}/health`;
            document.getElementById('installCommandModal').showModal();

            // Reload frontends list
            loadFrontends();

            // Reset form
            form.reset();
        } catch (error) {
            alert('Failed to create frontend: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<span>Deploy & Generate Command</span><i data-lucide="arrow-right" class="w-5 h-5"></i>';
            lucide.createIcons();
        }
    });

    // Copy install command
    document.getElementById('copyInstallCmd')?.addEventListener('click', () => {
        const command = document.getElementById('installCommand').textContent;
        navigator.clipboard.writeText(command);

        showToast("Command copied to clipboard");
    });

    // Test frontend
    async function testFrontend(domain) {
        showToast("Checking health...");
        try {
            const response = await fetch(`https://${domain}/health`, { signal: AbortSignal.timeout(5000) });
            const data = await response.json();
            alert(`✅ Frontend is healthy!\n\nStatus: ${data.status}\nRegion: ${data.region}`);
        } catch (error) {
            alert(`❌ Frontend is not responding:\n\n${error.message}`);
        }
    }

    // Delete frontend
    async function deleteFrontend(id, domain) {
        if (!confirm(`Are you sure you want to permanently delete ${domain}?\n\nThis action cannot be undone.`)) return;

        try {
            const response = await fetch(`/api/admin/frontends/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete');

            showToast("Frontend deleted successfully");
            loadFrontends();
        } catch (error) {
            alert('Failed to delete frontend: ' + error.message);
        }
    }

    // Rotate token
    async function rotateToken(id) {
        if (!confirm('Warning: Rotating the token will break the connection until you update the frontend server configuration.\n\nContinue?')) return;

        try {
            const response = await fetch(`/api/admin/frontends/${id}/rotate-token`, {
                method: 'POST'
            });

            if (!response.ok) throw new Error('Failed to rotate token');

            const data = await response.json();

            // Show new token in a simple prompt/alert for now
            prompt("New Token (Copy immediately):", data.token);
            loadFrontends();
        } catch (error) {
            alert('Failed to rotate token: ' + error.message);
        }
    }

    // Utilities
    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function timeAgo(dateStr) {
        const date = new Date(dateStr);
        // Need to handle if dateStr is naive or UTC. Assuming backend sends UTC ISO string.
        const seconds = Math.floor((new Date() - date) / 1000);

        // Future proofing for clock skew
        if (seconds < 0) return 'Just now';

        if (seconds < 60) return 'Just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
    }

    // Load on page load
    loadFrontends();

    // Refresh every 30 seconds
    setInterval(loadFrontends, 30000);
</script>
{% endblock %}