{% extends "base.html" %}

{% block title %}Promos{% endblock %}
{% block header_title %}Promo Center{% endblock %}

{% block content %}
<section class="space-y-6">
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4">Create Promo Code</h2>
        <form hx-post="{{ admin_path }}/promo/add" hx-swap="none" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="promo-form">
            <div>
                <label class="block text-xs text-slate-400 uppercase mb-1">Code</label>
                <input name="code" required placeholder="WELCOME30" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
            </div>
            <div>
                <label class="block text-xs text-slate-400 uppercase mb-1">Type</label>
                <select name="promo_type" id="promo_type" onchange="togglePromoFields()" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
                    <option value="balance">Balance</option>
                    <option value="subscription">Subscription</option>
                    <option value="trial">Trial</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 uppercase mb-1">Max Uses</label>
                <input type="number" name="max_uses" min="1" value="1" required class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
            </div>
            <div id="balance_amount_group">
                <label class="block text-xs text-slate-400 uppercase mb-1">Balance Amount</label>
                <input type="number" name="balance_amount" min="1" value="100" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
            </div>
            <div id="plan_id_group" class="hidden">
                <label class="block text-xs text-slate-400 uppercase mb-1">Plan</label>
                <select name="plan_id" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
                    <option value="">Select plan</option>
                    {% for plan in plans %}
                    <option value="{{ plan.id }}">{{ plan.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="duration_group" class="hidden">
                <label class="block text-xs text-slate-400 uppercase mb-1">Duration Days</label>
                <input type="number" name="duration_days" min="1" value="30" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
            </div>
            <div id="traffic_group" class="hidden">
                <label class="block text-xs text-slate-400 uppercase mb-1">Traffic GB (Optional)</label>
                <input type="number" name="traffic_gb" min="0" placeholder="0" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
            </div>
            <div>
                <label class="block text-xs text-slate-400 uppercase mb-1">Expires At (Optional)</label>
                <input type="date" name="expires_at" class="w-full bg-slate-950 border border-white/10 rounded-xl px-3 py-2 text-white">
            </div>
            <div class="md:col-span-2 lg:col-span-3 flex justify-end">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2.5 rounded-xl font-semibold">Create Promo</button>
            </div>
        </form>
    </div>

    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5 bg-slate-900/30">
                        <th class="px-4 py-3">Code</th>
                        <th class="px-4 py-3">Type</th>
                        <th class="px-4 py-3">Reward</th>
                        <th class="px-4 py-3">Usage</th>
                        <th class="px-4 py-3">Expires</th>
                        <th class="px-4 py-3 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5 text-sm">
                    {% if promos.is_empty() %}
                    <tr>
                        <td colspan="6" class="px-4 py-10 text-center text-slate-500">No promo codes yet.</td>
                    </tr>
                    {% else %}
                    {% for promo in promos %}
                    <tr id="promo-row-{{ promo.id }}" class="hover:bg-white/5">
                        <td class="px-4 py-3 font-mono text-indigo-300">{{ promo.code }}</td>
                        <td class="px-4 py-3 text-white">{{ promo.promo_type }}</td>
                        <td class="px-4 py-3 text-slate-300">
                            {% if promo.promo_type == "balance" %}
                            +{{ promo.balance_amount.unwrap_or(0) }} balance
                            {% else %}
                            plan #{{ promo.plan_id.unwrap_or(0) }}, {{ promo.duration_days.unwrap_or(0) }} days
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-slate-300">{{ promo.current_uses }}/{{ promo.max_uses }}</td>
                        <td class="px-4 py-3 text-slate-400">
                            {% if promo.expires_at.is_some() %}
                            {{ promo.expires_at.unwrap().format("%Y-%m-%d") }}
                            {% else %}
                            Never
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            <button
                                hx-delete="{{ admin_path }}/promo/{{ promo.id }}/delete"
                                hx-confirm="Delete promo {{ promo.code }}?"
                                hx-target="#promo-row-{{ promo.id }}"
                                hx-swap="outerHTML"
                                class="text-rose-400 hover:text-rose-300 px-2 py-1 rounded">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</section>

<script>
    function togglePromoFields() {
        const type = document.getElementById('promo_type')?.value || 'balance';
        const showPlan = type === 'subscription' || type === 'trial';
        document.getElementById('plan_id_group')?.classList.toggle('hidden', !showPlan);
        document.getElementById('duration_group')?.classList.toggle('hidden', !showPlan);
        document.getElementById('traffic_group')?.classList.toggle('hidden', !showPlan);
        document.getElementById('balance_amount_group')?.classList.toggle('hidden', showPlan);
    }
    togglePromoFields();
</script>
{% endblock %}
