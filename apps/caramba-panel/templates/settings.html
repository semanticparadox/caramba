{% extends "base.html" %}

{% block title %}Settings{% endblock %}
{% block header_title %}System Settings{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto pb-20">
    <!-- Main Settings Form (Invisible Wrapper) -->
    <form id="main-settings-form" hx-post="{{ admin_path }}/settings/save" hx-swap="none"></form>

    <!-- Tab Navigation -->
    <div
        class="flex items-center gap-1 p-1 bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-xl mb-8 overflow-x-auto">
        <button onclick="switchTab('general')" id="tab-general"
            class="tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all text-white bg-indigo-500 shadow-lg shadow-indigo-500/20">
            <i data-lucide="settings-2" class="w-4 h-4"></i> General
        </button>
        <button onclick="switchTab('payments')" id="tab-payments"
            class="tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="credit-card" class="w-4 h-4"></i> Payments
        </button>
        <button onclick="switchTab('frontend')" id="tab-frontend"
            class="tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="layout" class="w-4 h-4"></i> Frontend
        </button>
        <button onclick="switchTab('trials')" id="tab-trials"
            class="tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="gift" class="w-4 h-4"></i> Trials
        </button>
        <button onclick="switchTab('system')" id="tab-system"
            class="tab-btn flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg text-sm font-medium transition-all text-slate-400 hover:text-white hover:bg-white/5">
            <i data-lucide="server-cog" class="w-4 h-4"></i> System
        </button>
    </div>

    <!-- TABS CONTENT -->
    <div class="space-y-6">

        <!-- 1. GENERAL TAB -->
        <div id="content-general" class="tab-content block space-y-6 animate-fade-in">
            <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6">
                <header class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-slate-700/30 flex items-center justify-center text-slate-300">
                        <i data-lucide="globe" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">General Configuration</h3>
                        <p class="text-xs text-slate-500">Basic panel settings and personalization</p>
                    </div>
                </header>

                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Bot
                            Token</label>
                        <input type="text" form="main-settings-form" name="bot_token" value="{{ masked_bot_token }}"
                            placeholder="123456789:ABC..."
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                        <p class="text-[10px] text-slate-500 mt-1.5">Required for Mini App and notifications. <a
                                href="{{ admin_path }}/bot" class="text-indigo-400 hover:underline">Go to Bot
                                Console</a></p>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Brand
                            Name</label>
                        <input type="text" form="main-settings-form" name="brand_name" value="{{ brand_name }}"
                            placeholder="CARAMBA"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all text-sm">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Bot
                            Username (No @)</label>
                        <input type="text" form="main-settings-form" name="bot_username" value="{{ bot_username }}"
                            placeholder="autodetect on bot start"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all text-sm">
                        <p class="text-[10px] text-slate-500 mt-1.5">Usually auto-filled after successful bot start.</p>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Support
                            Username</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-slate-500">@</span>
                            <input type="text" form="main-settings-form" name="support_url" value="{{ support_url }}"
                                placeholder="admin_support"
                                class="w-full bg-slate-950 border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all text-sm">
                        </div>
                        <p class="text-[10px] text-slate-500 mt-1.5">Username for the support button in the bot.</p>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6">
                <header class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-xl bg-slate-700/30 flex items-center justify-center text-slate-300">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Terms of Service</h3>
                        <p class="text-xs text-slate-500">Displayed to new users during onboarding</p>
                    </div>
                </header>

                <textarea form="main-settings-form" name="terms_of_service"
                    class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm h-48 custom-scrollbar resize-y">{{ terms_of_service }}</textarea>
            </div>
        </div>

        <!-- 1.5 FRONTEND TAB -->
        <div id="content-frontend" class="tab-content hidden space-y-6 animate-fade-in">
            <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6">
                <header class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400">
                        <i data-lucide="layout" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Frontend & Subscription</h3>
                        <p class="text-xs text-slate-500">Configure how users access their subscriptions</p>
                    </div>
                </header>

                <div class="space-y-6">
                    <!-- Frontend Mode -->
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Frontend
                            Mode</label>
                        <select form="main-settings-form" name="frontend_mode"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-purple-500 outline-none transition-all text-sm appearance-none">
                            <option value="local" {% if frontend_mode=="local" %}selected{% endif %}>Local (Panel
                                Hosted)</option>
                            <option value="distributed" {% if frontend_mode=="distributed" %}selected{% endif %}>
                                Distributed (CDN/External)</option>
                        </select>
                        <p class="text-[10px] text-slate-500 mt-1.5">Local: Panel serves pages directly. Distributed:
                            Uses external nodes/CDNs.</p>
                    </div>

                    <!-- Subscription Domain -->
                    <div>
                        <label
                            class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Subscription
                            Domain (Optional)</label>
                        <input type="text" form="main-settings-form" name="subscription_domain"
                            value="{{ subscription_domain }}" placeholder="sub.example.com"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-purple-500 outline-none transition-all text-sm">
                        <p class="text-[10px] text-slate-500 mt-1.5">Custom domain for subscription links. Leave empty
                            to use Panel URL.</p>
                    </div>

                    <!-- Mini App Toggle -->
                    <div class="flex items-center justify-between p-4 bg-slate-950/30 border border-white/5 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                <i data-lucide="smartphone" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-white">Telegram Mini App</h4>
                                <p class="text-xs text-slate-400">Enable the embedded Telegram Mini App</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" form="main-settings-form" name="miniapp_enabled" value="true"
                                class="sr-only peer" {% if miniapp_enabled %}checked{% endif %}>
                            <div
                                class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                            </div>
                        </label>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Relay Auth Mode</label>
                        <select form="main-settings-form" name="relay_auth_mode"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-purple-500 outline-none transition-all text-sm appearance-none">
                            <option value="dual" {% if relay_auth_mode=="dual" %}selected{% endif %}>Dual (recommended rollout)</option>
                            <option value="v1" {% if relay_auth_mode=="v1" %}selected{% endif %}>V1 (derived only)</option>
                            <option value="legacy" {% if relay_auth_mode=="legacy" %}selected{% endif %}>Legacy (raw token)</option>
                        </select>
                        <p class="text-[10px] text-slate-500 mt-1.5">Controls inter-node relay credentials for Shadowsocks.</p>
                        <p class="text-[10px] text-amber-300 mt-1">Last legacy relay traffic: {{ relay_legacy_usage_last_seen_at }} ({{ relay_legacy_usage_last_seen_bytes }} bytes)</p>
                        <p class="text-[10px] text-slate-500 mt-1">Switch to <span class="font-semibold">v1</span> is blocked for 24h after the last observed <span class="font-mono">relay_*_legacy</span> traffic.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. PAYMENTS TAB -->
        <div id="content-payments" class="tab-content hidden space-y-6 animate-fade-in">
            <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6">
                <header class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                        <i data-lucide="wallet" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Payment Gateways</h3>
                        <p class="text-xs text-slate-500">Configure API keys for crypto payments</p>
                    </div>
                </header>

                <div class="mb-6 p-4 bg-indigo-500/10 border border-indigo-500/20 rounded-xl">
                    <h4 class="text-sm font-semibold text-indigo-300 mb-2">Registration Links (No IP/OOO Required)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                        <a href="http://t.me/CryptoBot" target="_blank"
                            class="flex items-center gap-1.5 text-slate-300 hover:text-white transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i> CryptoBot
                        </a>
                        <a href="https://aaio.so/" target="_blank"
                            class="flex items-center gap-1.5 text-slate-300 hover:text-white transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i> Aaio
                        </a>
                        <a href="https://cryptomus.com/" target="_blank"
                            class="flex items-center gap-1.5 text-slate-300 hover:text-white transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i> Cryptomus
                        </a>
                        <a href="https://crystalpay.io/" target="_blank"
                            class="flex items-center gap-1.5 text-slate-300 hover:text-white transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i> CrystalPay
                        </a>
                        <a href="https://nowpayments.io/" target="_blank"
                            class="flex items-center gap-1.5 text-slate-300 hover:text-white transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i> NowPayments
                        </a>
                        <a href="https://lava.top/" target="_blank"
                            class="flex items-center gap-1.5 text-slate-300 hover:text-white transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i> Lava.top
                        </a>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- Telegram Stars Toggle -->
                    <div
                        class="flex items-center justify-between p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-lg bg-amber-500/20 flex items-center justify-center text-amber-400">
                                <i data-lucide="star" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold text-white">Telegram Stars</h4>
                                <p class="text-xs text-slate-400">Enable payments via Telegram's native currency</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" form="main-settings-form" name="telegram_stars_enabled" value="true"
                                class="sr-only peer" {% if telegram_stars_enabled %}checked{% endif %}>
                            <div
                                class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500">
                            </div>
                        </label>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- CryptoBot -->
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5 flex items-center gap-2">
                                <i data-lucide="bot" class="w-3 h-3"></i> CryptoBot API Token
                            </label>
                            <input type="text" form="main-settings-form" name="payment_api_key"
                                value="{{ masked_payment_api_key }}" placeholder="1234:ABC..."
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                        </div>

                        <!-- NowPayments -->
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5 flex items-center gap-2">
                                <i data-lucide="credit-card" class="w-3 h-3"></i> NowPayments API Key
                            </label>
                            <input type="text" form="main-settings-form" name="nowpayments_api_key"
                                value="{{ masked_nowpayments_api_key }}" placeholder="API Key"
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                        </div>
                    </div>

                    <!-- Lava.top -->
                    <div class="p-4 bg-slate-950/30 border border-white/5 rounded-xl space-y-4">
                        <h4 class="text-sm font-medium text-slate-300 flex items-center gap-2">
                            <i data-lucide="flame" class="w-4 h-4 text-orange-500"></i> Lava.top Configuration
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Project
                                    ID</label>
                                <input type="text" form="main-settings-form" name="lava_project_id"
                                    value="{{ masked_lava_project_id }}" placeholder="Project ID"
                                    class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-orange-500 outline-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Secret
                                    Key</label>
                                <input type="text" form="main-settings-form" name="lava_secret_key"
                                    value="{{ masked_lava_secret_key }}" placeholder="Secret Key"
                                    class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-orange-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- AAIO -->
                    <div class="p-4 bg-slate-950/30 border border-white/5 rounded-xl space-y-4">
                        <h4 class="text-sm font-medium text-slate-300 flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4 text-pink-500"></i> Aaio Configuration
                        </h4>
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Merchant
                                ID</label>
                            <input type="text" form="main-settings-form" name="aaio_merchant_id"
                                value="{{ masked_aaio_merchant_id }}" placeholder="Merchant ID"
                                class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-pink-500 outline-none">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Secret
                                    #1</label>
                                <input type="text" form="main-settings-form" name="aaio_secret_1"
                                    value="{{ masked_aaio_secret_1 }}" placeholder="Secret 1"
                                    class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-pink-500 outline-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Secret
                                    #2</label>
                                <input type="text" form="main-settings-form" name="aaio_secret_2"
                                    value="{{ masked_aaio_secret_2 }}" placeholder="Secret 2"
                                    class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-pink-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Cryptomus -->
                    <div class="p-4 bg-slate-950/30 border border-white/5 rounded-xl space-y-4">
                        <h4 class="text-sm font-medium text-slate-300 flex items-center gap-2">
                            <i data-lucide="shield-check" class="w-4 h-4 text-emerald-500"></i> Cryptomus Configuration
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Merchant
                                    ID</label>
                                <input type="text" form="main-settings-form" name="cryptomus_merchant_id"
                                    value="{{ masked_cryptomus_merchant_id }}" placeholder="Merchant ID"
                                    class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-emerald-500 outline-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-medium text-slate-500 uppercase tracking-wider mb-1.5">Payment
                                    API Key</label>
                                <input type="text" form="main-settings-form" name="cryptomus_payment_api_key"
                                    value="{{ masked_cryptomus_payment_api_key }}" placeholder="API Key"
                                    class="w-full bg-slate-900 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:border-emerald-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-white/5">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">IPN
                                Callback URL</label>
                            <input type="url" form="main-settings-form" name="payment_ipn_url"
                                value="{{ payment_ipn_url }}" placeholder="https://..."
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all text-sm">
                        </div>

                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Exchange
                                Rate (Internal USD)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-3 text-slate-500">$</span>
                                <input type="number" form="main-settings-form" name="currency_rate" step="0.01"
                                    value="{{ currency_rate }}"
                                    class="w-full bg-slate-950 border border-white/10 rounded-xl pl-8 pr-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1.5">Fixed conversion rate if required.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. TRIALS TAB (Independent Form) -->
        <div id="content-trials" class="tab-content hidden space-y-6 animate-fade-in">
            <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6">
                <header class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400">
                        <i data-lucide="timer" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Trial Configuration</h3>
                        <p class="text-xs text-slate-500">Manage free trial periods for new users</p>
                    </div>
                </header>

                <form hx-post="{{ admin_path }}/tools/trial-config" hx-swap="none" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Default
                                Trial (Days)</label>
                            <input type="number" name="free_trial_days" value="{{ free_trial_days }}" min="1" max="365"
                                required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-orange-500 outline-none transition-all text-sm">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Channel
                                Member Trial (Days)</label>
                            <input type="number" name="channel_trial_days" value="{{ channel_trial_days }}" min="1"
                                max="365" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-orange-500 outline-none transition-all text-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Traffic
                                Limit (GB)</label>
                            <input type="number" name="free_trial_traffic_limit" value="{{ free_trial_traffic_limit }}"
                                min="1" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-orange-500 outline-none transition-all text-sm">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Device
                                Limit</label>
                            <input type="number" name="free_trial_device_limit" value="{{ free_trial_device_limit }}"
                                min="1" required
                                class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-orange-500 outline-none transition-all text-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Required
                            Channel ID (Optional)</label>
                        <input type="text" name="required_channel_id" value="{{ required_channel_id }}"
                            placeholder="-100..."
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-orange-500 outline-none transition-all text-sm">
                        <p class="text-[10px] text-slate-500 mt-1.5">Telegram channel ID (e.g., -100123456) for extended
                            trials. Leave empty to disable.</p>
                    </div>

                    <div class="pt-4">
                        <button type="submit"
                            class="flex items-center gap-2 bg-orange-600 hover:bg-orange-500 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg shadow-orange-500/20 transition-all">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Update Trial Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 4. SYSTEM TAB -->
        <div id="content-system" class="tab-content hidden space-y-6 animate-fade-in">

            <!-- Deployment Topology -->
            <div
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-cyan-500/20 transition-all">
                <header class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-300">
                        <i data-lucide="network" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Deployment Topology</h3>
                        <p class="text-xs text-slate-500">Choose architecture mode and service placement. Root URL is hidden; admin UI works only via configured path.</p>
                    </div>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Topology Mode</label>
                        <select form="main-settings-form" name="deployment_mode"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-cyan-500 outline-none transition-all text-sm">
                            <option value="hub" {% if deployment_mode=="hub" %}selected{% endif %}>Hub (single host: panel + sub + optional bot)</option>
                            <option value="distributed" {% if deployment_mode=="distributed" %}selected{% endif %}>Distributed (control-plane + external services)</option>
                        </select>
                        <p class="text-[11px] text-slate-500 mt-1">In distributed mode, frontend mode is forced to distributed.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Panel API URL (base)</label>
                        <input type="text" form="main-settings-form" name="panel_url"
                            value="{{ panel_url }}" placeholder="https://panel.example.com"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-cyan-500 outline-none transition-all font-mono text-sm">
                        <p class="text-[11px] text-slate-500 mt-1">Base URL for API, installer and node/sub/bot agents. Do not append admin path here.</p>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Admin UI URL (hidden path)</label>
                    <input type="text" value="{{ admin_ui_url_display }}" readonly
                        class="w-full bg-slate-950/60 border border-cyan-500/30 rounded-xl px-4 py-3 text-cyan-200 font-mono text-sm">
                    <p class="text-[11px] text-slate-500 mt-1">Root URL is intentionally hidden; access panel only via this path.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mb-4">
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 p-3">
                        <p class="text-[10px] text-slate-500 uppercase">Panel API</p>
                        <p class="text-sm text-white mt-1">Local control-plane</p>
                        <p class="text-[11px] mt-1 {% if local_panel_detected %}text-emerald-300{% else %}text-amber-300{% endif %}">
                            installed: {% if local_panel_detected %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_panel_active %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            active: {% if local_panel_active %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_panel_enabled %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            enabled: {% if local_panel_enabled %}yes{% else %}no{% endif %}
                        </p>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 p-3">
                        <p class="text-[10px] text-slate-500 uppercase">Sub / Frontend</p>
                        <p class="text-sm text-white mt-1">
                            {% if deployment_mode == "distributed" %}External edge servers{% else %}Local or mixed{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_sub_detected %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            installed: {% if local_sub_detected %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_sub_active %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            active: {% if local_sub_active %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_sub_enabled %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            enabled: {% if local_sub_enabled %}yes{% else %}no{% endif %}
                        </p>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 p-3">
                        <p class="text-[10px] text-slate-500 uppercase">Telegram Bot</p>
                        <p class="text-sm text-white mt-1">
                            {% if deployment_mode == "distributed" %}Recommended external worker{% else %}Local or external{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_bot_detected %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            installed: {% if local_bot_detected %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_bot_active %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            active: {% if local_bot_active %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_bot_enabled %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            enabled: {% if local_bot_enabled %}yes{% else %}no{% endif %}
                        </p>
                    </div>
                    <div class="rounded-xl border border-white/10 bg-slate-950/40 p-3">
                        <p class="text-[10px] text-slate-500 uppercase">Node Agents</p>
                        <p class="text-sm text-white mt-1">Always external</p>
                        <p class="text-[11px] mt-1 {% if local_node_detected %}text-amber-300{% else %}text-slate-500{% endif %}">
                            installed: {% if local_node_detected %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_node_active %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            active: {% if local_node_active %}yes{% else %}no{% endif %}
                        </p>
                        <p class="text-[11px] mt-1 {% if local_node_enabled %}text-emerald-300{% else %}text-slate-500{% endif %}">
                            enabled: {% if local_node_enabled %}yes{% else %}no{% endif %}
                        </p>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-2">
                    <button type="button"
                        hx-post="{{ admin_path }}/settings/topology/apply"
                        hx-target="#topology-apply-result"
                        hx-swap="innerHTML"
                        class="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-lg shadow-cyan-500/20">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                        Apply Topology on This Host
                    </button>
                    <p class="text-[11px] text-slate-500">Applies service mode locally: in distributed mode it disables local sub/bot; in hub mode it enables local panel/sub/bot if installed.</p>
                </div>
                <div id="topology-apply-result"></div>

                <div class="rounded-xl border border-indigo-500/20 bg-indigo-500/5 p-4 space-y-4">
                    <div class="flex items-center justify-between gap-3">
                        <p class="text-xs text-slate-200">Quick install commands (ready to run)</p>
                        <a href="{{ admin_path }}/api-keys" class="text-[11px] text-cyan-300 hover:text-cyan-200">Manage Enrollment Keys</a>
                    </div>

                    <div class="space-y-2">
                        <div class="rounded-lg border border-white/10 bg-slate-950/50 p-2.5">
                            <div class="flex items-center justify-between mb-1.5">
                                <span class="text-[11px] text-slate-300 font-semibold uppercase tracking-wide">Node Server</span>
                                <button type="button" onclick="copyInstallerCommand('install-cmd-node', this)"
                                    class="text-[11px] px-2 py-1 rounded border border-white/15 text-slate-300 hover:bg-white/5 transition-colors">Copy</button>
                            </div>
                            <div id="install-cmd-node" class="font-mono text-[11px] text-slate-300 break-all">{{ installer_node_command }}</div>
                        </div>

                        <div class="rounded-lg border border-white/10 bg-slate-950/50 p-2.5">
                            <div class="flex items-center justify-between mb-1.5">
                                <span class="text-[11px] text-slate-300 font-semibold uppercase tracking-wide">Sub Worker</span>
                                <button type="button" onclick="copyInstallerCommand('install-cmd-sub', this)"
                                    class="text-[11px] px-2 py-1 rounded border border-white/15 text-slate-300 hover:bg-white/5 transition-colors">Copy</button>
                            </div>
                            <div id="install-cmd-sub" class="font-mono text-[11px] text-slate-300 break-all">{{ installer_sub_command }}</div>
                        </div>

                        <div class="rounded-lg border border-white/10 bg-slate-950/50 p-2.5">
                            <div class="flex items-center justify-between mb-1.5">
                                <span class="text-[11px] text-slate-300 font-semibold uppercase tracking-wide">Bot Worker</span>
                                <button type="button" onclick="copyInstallerCommand('install-cmd-bot', this)"
                                    class="text-[11px] px-2 py-1 rounded border border-white/15 text-slate-300 hover:bg-white/5 transition-colors">Copy</button>
                            </div>
                            <div id="install-cmd-bot" class="font-mono text-[11px] text-slate-300 break-all">{{ installer_bot_command }}</div>
                        </div>
                    </div>

                    <div class="rounded-lg border border-white/10 bg-slate-950/40 p-3 text-[11px] text-slate-400 space-y-1.5">
                        <p><span class="text-slate-200">Auto-generated enrollment key:</span> <span class="font-mono text-cyan-300 break-all">{{ installer_enrollment_key }}</span></p>
                        <p><span class="text-slate-200">Internal API token:</span>
                            {% if installer_sub_token_ready %}
                            <span class="font-mono text-cyan-300 break-all">{{ installer_sub_token }}</span>
                            {% if internal_api_token_source == "env" %}
                            <span class="ml-1 text-emerald-300">(from environment)</span>
                            {% else if internal_api_token_source == "generated" %}
                            <span class="ml-1 text-emerald-300">(auto-generated and saved)</span>
                            {% else if internal_api_token_source == "settings" %}
                            <span class="ml-1 text-cyan-300">(loaded from panel settings)</span>
                            {% endif %}
                            {% else %}
                            <span class="text-rose-300">unavailable (failed to generate)</span>
                            {% endif %}
                        </p>
                        <p>Node-specific one-time token is still available from <a href="{{ admin_path }}/nodes" class="text-cyan-300 hover:text-cyan-200">Nodes → Add Node → Install</a>.</p>
                    </div>

                    <div>
                        <p class="text-xs text-slate-300 mb-2">Role upgrade command (already installed host):</p>
                        <div class="font-mono text-slate-300 break-all text-[11px]">sudo caramba upgrade</div>
                    </div>
                </div>
            </div>

            <!-- Update Overview -->
            <div
                class="bg-slate-900/40 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6">
                <header class="flex items-center gap-3 mb-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-300">
                        <i data-lucide="info" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Update Center</h3>
                        <p class="text-xs text-slate-500">One place for hub/panel and node-agent update flow.</p>
                    </div>
                </header>
                <ul class="space-y-1.5 text-xs text-slate-400">
                    <li>1. <span class="text-slate-200">{% if deployment_mode == "distributed" %}Control-plane update{% else %}Hub update{% endif %}</span>: runs installer smart-upgrade on this host (keeps current config and credentials).</li>
                    <li>2. <span class="text-slate-200">Node agents</span>: prepare release metadata + rollout signal. Nodes self-update on heartbeat.</li>
                    <li>3. <span class="text-slate-200">Sub/Bot workers</span>: run installer upgrade on each worker host (`sudo caramba upgrade`).</li>
                    <li>4. <span class="text-slate-200">Frontend servers</span>: independent edge services, updated per host via installer.</li>
                </ul>
            </div>

            <!-- Hub Update -->
            <div
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-emerald-500/20 transition-all">
                <header class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center text-emerald-400">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">{% if deployment_mode == "distributed" %}Control-plane Update{% else %}Hub Update{% endif %}</h3>
                        <p class="text-xs text-slate-500">Checks latest stable release and shows installer command for current topology mode. Existing installs are upgraded without prompt loops.</p>
                    </div>
                </header>

                <div class="flex items-center justify-between" id="update-status-container">
                    <div>
                        <p class="text-sm text-slate-400">Current Version: <span class="text-white font-mono">{{ current_version }}</span></p>
                    </div>
                    <button hx-post="{{ admin_path }}/settings/update/check" hx-target="#update-status-container"
                        hx-swap="outerHTML"
                        class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white font-medium py-2 px-4 rounded-lg transition-all border border-white/5">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Check for Updates
                    </button>
                </div>
            </div>

            <!-- Advanced Controls -->
            <details
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-indigo-500/20 transition-all">
                <summary class="cursor-pointer flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-300">
                            <i data-lucide="settings-2" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Advanced Controls</h3>
                            <p class="text-xs text-slate-500">Rollout internals, worker diagnostics and safety/obfuscation toggles. Optional for normal operation.</p>
                        </div>
                    </div>
                    <span class="text-xs text-slate-400">click to expand</span>
                </summary>

                <div class="mt-6 space-y-6">

            <!-- Agent Rollout -->
            <div
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-indigo-500/20 transition-all">
                <header class="flex items-center gap-3 mb-6">
                    <div
                        class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-300">
                        <i data-lucide="cpu" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Node Agent Rollout</h3>
                        <p class="text-xs text-slate-500">Default flow: prepare latest release, then rollout to active nodes.</p>
                    </div>
                </header>

                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="rounded-xl border border-white/10 bg-slate-950/40 p-4 space-y-2">
                            <p class="text-[11px] uppercase tracking-wider text-slate-500">Current Agent Release Metadata</p>
                            <p class="text-sm text-white"><span class="text-slate-400">Version:</span> <span class="font-mono">{{ agent_latest_version }}</span></p>
                            <p class="text-sm text-white break-all"><span class="text-slate-400">Binary URL:</span> <span class="font-mono text-xs">{{ agent_update_url }}</span></p>
                            <p class="text-sm text-white break-all"><span class="text-slate-400">SHA256:</span> <span class="font-mono text-xs">{{ agent_update_hash }}</span></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Auto-rollout on heartbeat</label>
                            <div class="flex items-center justify-between p-3 bg-slate-950/30 rounded-xl border border-white/5">
                                <div>
                                    <span class="block text-xs font-bold text-white">Auto Update Agents</span>
                                    <span class="text-[10px] text-slate-500">If enabled, active nodes follow latest version.</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="hidden" form="main-settings-form" name="auto_update_agents" value="false">
                                    <input type="checkbox" form="main-settings-form" name="auto_update_agents" value="true"
                                        class="sr-only peer" {% if auto_update_agents %}checked{% endif %}>
                                    <div
                                        class="w-9 h-5 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-500">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 pt-2">
                        <button type="button"
                            hx-post="{{ admin_path }}/settings/update/agent/prepare"
                            hx-target="#agent-rollout-result"
                            hx-swap="innerHTML"
                            class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-lg shadow-indigo-500/20">
                            <i data-lucide="download-cloud" class="w-4 h-4"></i> Prepare from Latest Release
                        </button>
                        <button type="button"
                            hx-post="{{ admin_path }}/settings/update/agent/rollout"
                            hx-target="#agent-rollout-result"
                            hx-swap="innerHTML"
                            class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-lg shadow-emerald-500/20">
                            <i data-lucide="send" class="w-4 h-4"></i> Rollout to Active Nodes
                        </button>
                    </div>

                    <div id="agent-rollout-result"></div>
                    <div class="text-[11px] text-slate-500">
                        Tip: after changing fields manually, click global <span class="text-slate-300">Save Configuration</span>, then run rollout.
                    </div>

                    <details class="rounded-xl border border-white/10 bg-slate-950/30 p-4">
                        <summary class="cursor-pointer text-sm text-slate-200 font-medium">Manual Override (Advanced)</summary>
                        <p class="text-xs text-slate-500 mt-2 mb-3">Only use this if you need a custom binary or pin specific version/hash.</p>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Agent Version</label>
                                <input type="text" form="main-settings-form" name="agent_latest_version"
                                    value="{{ agent_latest_version }}" placeholder="v0.3.26"
                                    class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Agent Binary URL</label>
                                <input type="text" form="main-settings-form" name="agent_update_url"
                                    value="{{ agent_update_url }}" placeholder="https://github.com/.../caramba-node"
                                    class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Agent SHA256 Hash</label>
                                <input type="text" form="main-settings-form" name="agent_update_hash"
                                    value="{{ agent_update_hash }}" placeholder="64-char sha256"
                                    class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-indigo-500 outline-none transition-all font-mono text-sm">
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Worker Rollout -->
            <details
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-cyan-500/20 transition-all">
                <summary class="cursor-pointer flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-300">
                            <i data-lucide="satellite" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Advanced: Sub/Bot Worker Rollout</h3>
                            <p class="text-xs text-slate-500">Open only if you run remote sub/bot workers and need rollout diagnostics.</p>
                        </div>
                    </div>
                    <span class="text-xs text-slate-400">Workers: {{ worker_total_count }} / Online: {{ worker_online_count }}</span>
                </summary>

                <div class="mt-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="rounded-xl border border-white/10 bg-slate-950/40 p-4">
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Sub Worker</p>
                            <p class="text-sm text-white mt-1 font-mono">{% if sub_worker_target_version == "" %}not set{% else %}{{ sub_worker_target_version }}{% endif %}</p>
                            <p class="text-[11px] text-slate-500 mt-1 break-all">{% if sub_worker_update_url == "" %}URL is not set{% else %}{{ sub_worker_update_url }}{% endif %}</p>
                        </div>
                        <div class="rounded-xl border border-white/10 bg-slate-950/40 p-4">
                            <p class="text-xs text-slate-400 uppercase tracking-wider">Bot Worker</p>
                            <p class="text-sm text-white mt-1 font-mono">{% if bot_worker_target_version == "" %}not set{% else %}{{ bot_worker_target_version }}{% endif %}</p>
                            <p class="text-[11px] text-slate-500 mt-1 break-all">{% if bot_worker_update_url == "" %}URL is not set{% else %}{{ bot_worker_update_url }}{% endif %}</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                            hx-post="{{ admin_path }}/settings/update/worker/queue"
                            hx-vals='{"role":"sub"}'
                            hx-target="#worker-update-result"
                            hx-swap="innerHTML"
                            class="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-500 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-lg shadow-cyan-500/20">
                            <i data-lucide="send" class="w-4 h-4"></i> Queue Latest Sub Update
                        </button>
                        <button type="button"
                            hx-post="{{ admin_path }}/settings/update/worker/queue"
                            hx-vals='{"role":"bot"}'
                            hx-target="#worker-update-result"
                            hx-swap="innerHTML"
                            class="flex items-center gap-2 bg-cyan-700 hover:bg-cyan-600 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-lg shadow-cyan-700/20">
                            <i data-lucide="send" class="w-4 h-4"></i> Queue Latest Bot Update
                        </button>
                    </div>
                    <div id="worker-update-result"></div>

                    <div class="mt-4 rounded-xl border border-white/10 bg-slate-950/30 overflow-hidden">
                        <div class="px-4 py-2 border-b border-white/10">
                            <p class="text-xs text-slate-300">Worker Inventory</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="text-slate-500 text-xs uppercase tracking-wider">
                                    <tr>
                                        <th class="text-left px-4 py-2">Role</th>
                                        <th class="text-left px-4 py-2">Worker</th>
                                        <th class="text-left px-4 py-2">Reachability</th>
                                        <th class="text-left px-4 py-2">Last State</th>
                                        <th class="text-left px-4 py-2">Version</th>
                                        <th class="text-left px-4 py-2">Last Seen</th>
                                        <th class="text-left px-4 py-2">Message</th>
                                    </tr>
                                </thead>
                                <tbody class="text-slate-300">
                                    {% if worker_inventory.len() == 0 %}
                                    <tr>
                                        <td colspan="7" class="px-4 py-3 text-slate-500">No workers have polled yet.</td>
                                    </tr>
                                    {% endif %}
                                    {% for w in worker_inventory %}
                                    <tr class="border-t border-white/5">
                                        <td class="px-4 py-2">{{ w.role }}</td>
                                        <td class="px-4 py-2 font-mono text-xs">{{ w.worker_id }}</td>
                                        <td class="px-4 py-2">
                                            {% if w.is_online %}
                                            <span class="rounded-full bg-emerald-500/15 border border-emerald-500/30 px-2 py-0.5 text-emerald-300 text-xs">online</span>
                                            {% else %}
                                            <span class="rounded-full bg-rose-500/10 border border-rose-500/30 px-2 py-0.5 text-rose-300 text-xs">offline</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-4 py-2 text-xs">{{ w.last_state }}</td>
                                        <td class="px-4 py-2 font-mono text-xs">{{ w.current_version }} → {{ w.target_version }}</td>
                                        <td class="px-4 py-2 text-xs text-slate-400">{{ w.last_seen_ago }}<br>{{ w.last_seen }}</td>
                                        <td class="px-4 py-2 text-xs text-slate-400">{{ w.last_message }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-4 rounded-xl border border-white/10 bg-slate-950/30 overflow-hidden">
                        <div class="px-4 py-2 border-b border-white/10">
                            <p class="text-xs text-slate-300">Recent Worker Update Reports</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="text-slate-500 text-xs uppercase tracking-wider">
                                    <tr>
                                        <th class="text-left px-4 py-2">Time</th>
                                        <th class="text-left px-4 py-2">Role</th>
                                        <th class="text-left px-4 py-2">Worker</th>
                                        <th class="text-left px-4 py-2">Status</th>
                                        <th class="text-left px-4 py-2">Version</th>
                                        <th class="text-left px-4 py-2">Message</th>
                                    </tr>
                                </thead>
                                <tbody class="text-slate-300">
                                    {% if worker_update_reports.len() == 0 %}
                                    <tr>
                                        <td colspan="6" class="px-4 py-3 text-slate-500">No worker reports yet.</td>
                                    </tr>
                                    {% endif %}
                                    {% for row in worker_update_reports %}
                                    <tr class="border-t border-white/5">
                                        <td class="px-4 py-2 text-xs text-slate-400">{{ row.created_at }}</td>
                                        <td class="px-4 py-2">{{ row.role }}</td>
                                        <td class="px-4 py-2 font-mono text-xs">{{ row.worker_id }}</td>
                                        <td class="px-4 py-2">{{ row.status }}</td>
                                        <td class="px-4 py-2 font-mono text-xs">{{ row.current_version }} → {{ row.target_version }}</td>
                                        <td class="px-4 py-2 text-xs text-slate-400">{{ row.message }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <p class="text-[11px] text-slate-500 mt-3">
                        For Bot worker polling, install bot with
                        <span class="font-mono">--panel-token {% if installer_sub_token_ready %}{{ installer_sub_token }}{% else %}&lt;INTERNAL_API_TOKEN&gt;{% endif %}</span>.
                    </p>
                </div>
            </details>

            <!-- Backup Section (Moved from Tools) -->
            <div
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-blue-500/20 transition-all">
                <header class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400">
                        <i data-lucide="database-backup" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white">Database Backup</h3>
                        <p class="text-xs text-slate-500">Export system data and configuration</p>
                    </div>
                </header>

                <div class="flex items-center justify-between">
                    <div>
                        {% if last_export != "Never" %}
                        <p class="text-sm text-slate-400">Last backup: <span class="text-white font-mono">{{ last_export
                                }}</span></p>
                        {% else %}
                        <p class="text-sm text-slate-400">No backups created yet.</p>
                        {% endif %}
                    </div>
                    <a href="{{ admin_path }}/tools/export"
                        class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white font-medium py-2 px-4 rounded-lg transition-all shadow-lg shadow-blue-500/20">
                        <i data-lucide="download" class="w-4 h-4"></i> Download Archive
                    </a>
                </div>
            </div>

            <!-- Decoy Traffic -->
            <div
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-purple-500/20 transition-all">
                <header class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400">
                            <i data-lucide="ghost" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Decoy Traffic Generator</h3>
                            <p class="text-xs text-slate-500">Generate fake traffic to mask VPN signatures</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" form="main-settings-form" name="decoy_enabled" class="sr-only peer" {% if
                            decoy_enabled %}checked{% endif %}>
                        <div
                            class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-purple-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600">
                        </div>
                    </label>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Target
                            URLs (JSON)</label>
                        <input type="text" form="main-settings-form" name="decoy_urls" value="{{ decoy_urls }}"
                            placeholder='["https://google.com", ...]'
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-purple-500 outline-none transition-all font-mono text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Min
                            Interval (s)</label>
                        <input type="number" form="main-settings-form" name="decoy_min_interval"
                            value="{{ decoy_min_interval }}"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-purple-500 outline-none transition-all text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Max
                            Interval (s)</label>
                        <input type="number" form="main-settings-form" name="decoy_max_interval"
                            value="{{ decoy_max_interval }}"
                            class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-purple-500 outline-none transition-all text-sm">
                    </div>
                </div>
            </div>

            <!-- Kill Switch -->
            <div
                class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden p-6 hover:border-red-500/20 transition-all">
                <header class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center text-red-500">
                            <i data-lucide="skull" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Emergency Kill Switch</h3>
                            <p class="text-xs text-slate-500">Auto-terminate nodes if panel connection is lost</p>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" form="main-settings-form" name="kill_switch_enabled" class="sr-only peer"
                            {% if kill_switch_enabled %}checked{% endif %}>
                        <div
                            class="w-11 h-6 bg-slate-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600">
                        </div>
                    </label>
                </header>

                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-1.5">Timeout
                        (Seconds)</label>
                    <input type="number" form="main-settings-form" name="kill_switch_timeout"
                        value="{{ kill_switch_timeout }}" placeholder="300"
                        class="w-full bg-slate-950 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:border-red-500 outline-none transition-all text-sm">
                </div>
            </div>

                </div>
            </details>
        </div>
    </div>

    <!-- Sticky Save Button (Main Form Only) -->
    <!-- We hide this button when on 'trials' tab since trials has its own save button -->
    <div id="sticky-save-btn" class="fixed bottom-6 right-6 z-50 transition-opacity duration-300">
        <button type="submit" form="main-settings-form"
            class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-full shadow-lg shadow-indigo-500/30 transition-all hover:scale-105 active:scale-95 border border-indigo-500/20 backdrop-blur-sm">
            <i data-lucide="save" class="w-5 h-5"></i>
            Save Configuration
        </button>
    </div>
</section>

<style>
    .tab-btn.active {
        background-color: rgb(99 102 241);
        /* indigo-500 */
        color: white;
        box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2);
    }

    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    function copyInstallerCommand(elementId, button) {
        const el = document.getElementById(elementId);
        if (!el) return;
        const text = el.innerText.trim();
        if (!text) return;

        navigator.clipboard.writeText(text).then(() => {
            if (button) {
                const prev = button.innerText;
                button.innerText = 'Copied';
                button.classList.add('text-emerald-300');
                setTimeout(() => {
                    button.innerText = prev;
                    button.classList.remove('text-emerald-300');
                }, 900);
            }
        }).catch(() => {
            const range = document.createRange();
            range.selectNodeContents(el);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        });
    }

    function switchTab(tabId) {
        // Build tab IDs
        const tabs = ['general', 'payments', 'frontend', 'trials', 'system'];

        tabs.forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            const content = document.getElementById(`content-${t}`);

            if (t === tabId) {
                // Active State
                btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                btn.classList.add('bg-indigo-500', 'text-white', 'shadow-lg', 'shadow-indigo-500/20');
                content.classList.remove('hidden');
                content.classList.add('block');
            } else {
                // Inactive State
                btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                btn.classList.remove('bg-indigo-500', 'text-white', 'shadow-lg', 'shadow-indigo-500/20');
                content.classList.add('hidden');
                content.classList.remove('block');
            }
        });

        // Hide main save button on Trials tab (it has own button)
        const saveBtn = document.getElementById('sticky-save-btn');
        if (tabId === 'trials') {
            saveBtn.style.opacity = '0';
            saveBtn.style.pointerEvents = 'none';
        } else {
            saveBtn.style.opacity = '1';
            saveBtn.style.pointerEvents = 'auto';
        }

        // Re-init icons just in case icons inside hidden tabs need it (sometimes SVGs behave weirdly)
        if (window.lucide) lucide.createIcons();
    }
</script>
{% endblock %}
