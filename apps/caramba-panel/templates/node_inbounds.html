{% extends "base.html" %}

{% block title %}Node Inbounds{% endblock %}
{% block header_title %}Node Inbounds{% endblock %}

{% block content %}
<section class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <i data-lucide="network" class="w-6 h-6 text-indigo-400"></i>
                Manage Inbounds
            </h2>
            <div class="flex items-center gap-2 text-sm text-slate-400 mt-1">
                <span class="font-mono text-indigo-300">{{ node.name }}</span>
                <span class="text-slate-600">•</span>
                <span class="font-mono bg-slate-800 px-1.5 py-0.5 rounded text-xs">{{ node.ip }}</span>
                {% if !groups.is_empty() %}
                <span class="text-slate-600">•</span>
                <div class="flex gap-1.5">
                    {% for group in groups %}
                    <span
                        class="px-2 py-0.5 rounded bg-indigo-500/10 text-indigo-400 text-[10px] font-bold border border-indigo-500/20">
                        {{ group.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/sync" hx-swap="none"
                hx-confirm="Regenerate and push current node config without deleting manual inbounds?"
                class="flex items-center gap-2 px-4 py-2 bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 border border-indigo-500/20 rounded-xl text-sm font-medium transition-all group">
                <i data-lucide="refresh-cw"
                    class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                Sync from Templates
            </button>
            <a href="{{ admin_path }}/nodes"
                class="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white text-sm font-medium rounded-xl transition-colors border border-white/5">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Nodes
            </a>
        </div>
    </div>

    <!-- Inbounds List -->
    <div class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl overflow-hidden shadow-xl">
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-slate-900/30">
            <h3 class="text-lg font-semibold text-white">Active Inbounds</h3>
            <div class="flex items-center gap-3">
                <span
                    class="px-2.5 py-1 rounded-full text-xs font-medium bg-indigo-500/10 text-indigo-400 border border-indigo-500/20">
                    {{ inbounds.len() }} Configured
                </span>
                <button onclick="document.getElementById('add-inbound-modal').showModal()"
                    class="flex items-center gap-2 px-3 py-1.5 bg-emerald-600/10 hover:bg-emerald-600/20 text-emerald-400 border border-emerald-500/20 rounded-lg text-xs font-medium transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i> Add Inbound
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-white/5 bg-slate-900/30">
                        <th class="px-6 py-4">Tag</th>
                        <th class="px-6 py-4">Protocol</th>
                        <th class="px-6 py-4">Port</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for inbound in inbounds %}
                    <tr id="inbound-row-{{ inbound.id }}" class="hover:bg-white/5 transition-colors group">
                        <td class="px-6 py-4">
                            <div class="flex flex-col">
                                <span class="font-medium text-white">
                                    {% if let Some(remark) = inbound.remark %}
                                    {{ remark }}
                                    {% else %}
                                    {{ inbound.tag }}
                                    {% endif %}
                                </span>
                                <span class="text-[10px] text-slate-500 font-mono">
                                    {{ inbound.tag }}
                                    {% if inbound.tag.starts_with("tpl_") %}
                                    • <span class="text-indigo-400">Group Managed</span>
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span
                                class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-slate-800 text-slate-300 border border-white/5 font-mono">
                                {{ inbound.protocol|upper }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-slate-400 font-mono">{{ inbound.listen_port }}</td>
                        <td class="px-6 py-4">
                            {% if inbound.enable %}
                            <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}/toggle"
                                hx-swap="none"
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 hover:bg-emerald-500/20 cursor-pointer transition-colors"
                                title="Click to Disable">
                                Enabled
                            </button>
                            {% else %}
                            <button hx-post="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}/toggle"
                                hx-swap="none"
                                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-500/10 text-slate-400 border border-slate-500/20 hover:bg-slate-500/20 cursor-pointer transition-colors"
                                title="Click to Enable">
                                Disabled
                            </button>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                {% if inbound.tag.starts_with("tpl_") %}
                                <span class="text-xs text-slate-500 font-medium italic mr-2 flex items-center gap-1">
                                    <i data-lucide="lock" class="w-3 h-3"></i> Managed
                                </span>
                                {% else %}
                                <button
                                    class="p-2 rounded-lg bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 hover:text-indigo-300 transition-colors border border-indigo-500/10"
                                    hx-get="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}"
                                    hx-target="#edit-inbound-modal-content"
                                    hx-on::after-request="document.getElementById('edit-inbound-modal').showModal()">
                                    <i data-lucide="settings-2" class="w-4 h-4"></i>
                                </button>
                                <button
                                    class="p-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 hover:text-red-300 transition-colors border border-red-500/10"
                                    hx-delete="{{ admin_path }}/nodes/{{ node.id }}/inbounds/{{ inbound.id }}"
                                    hx-confirm="Delete inbound {{ inbound.tag }}?"
                                    hx-target="#inbound-row-{{ inbound.id }}" hx-swap="outerHTML">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}

                    {% if inbounds.is_empty() %}
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-12 h-12 rounded-full bg-slate-800/50 flex items-center justify-center">
                                    <i data-lucide="network" class="w-6 h-6 text-slate-600"></i>
                                </div>
                                <p>No inbounds configured for this node.</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Inbound Modal -->
    <dialog id="edit-inbound-modal"
        class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm z-50">
        <div id="edit-inbound-modal-content"
            class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-center p-12 text-slate-500">
                <i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-3"></i> Loading...
            </div>
        </div>
    </dialog>

    <!-- ADD INBOUND MODAL -->
    <dialog id="add-inbound-modal"
        class="backdrop:bg-slate-950/80 bg-transparent p-0 open:animate-fade-in backdrop:backdrop-blur-sm z-50">
        <div class="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto m-4 p-6"
            onclick="event.stopPropagation()">
            <header class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white">Add New Inbound</h3>
                <form method="dialog">
                    <button class="text-slate-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </form>
            </header>

            <form hx-post="{{ admin_path }}/nodes/{{ node.id }}/inbounds" hx-swap="none" class="space-y-4">
                <div class="p-3 rounded-xl bg-slate-800/60 border border-white/10 text-xs text-slate-400">
                    Recommended flow: pick a template first, verify port/SNI values, then save. Manual JSON is for advanced overrides.
                </div>

                <!-- BORROW TEMPLATE -->
                <div class="p-4 rounded-xl bg-indigo-500/5 border border-indigo-500/10 mb-6">
                    <label class="block text-xs font-medium text-indigo-300 uppercase mb-2">Borrow Settings from
                        Template</label>
                    <select id="borrow-template-select"
                        class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                        <option value="">-- Select a Template --</option>
                        {% for tpl in templates %}
                        <option value="{{ tpl.id }}">{{ tpl.name }} ({{ tpl.protocol }})</option>
                        {% endfor %}
                    </select>
                    <p class="text-[10px] text-slate-500 mt-2">Select a template to auto-fill the settings below.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase mb-1">Tag</label>
                        <input type="text" name="tag" required placeholder="inbound-1"
                            class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase mb-1">Protocol</label>
                        <select name="protocol" id="add_protocol" required
                            class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                            <option value="vless">VLESS</option>
                            <option value="hysteria2">Hysteria 2</option>
                            <option value="trojan">Trojan</option>
                            <option value="shadowsocks">Shadowsocks</option>
                            <option value="vmess">VMess</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase mb-1">Listen IP</label>
                        <input type="text" name="listen_ip" value="0.0.0.0" required
                            class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors font-mono">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 uppercase mb-1">Listen Port</label>
                        <input type="number" name="listen_port" required value="443" min="1" max="65535" placeholder="443"
                            class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors font-mono">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase mb-1">Remark</label>
                    <input type="text" name="remark" placeholder="Optional description"
                        class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-2.5 text-sm text-white focus:outline-none focus:border-indigo-500 transition-colors">
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase mb-1">
                        Settings JSON
                        <span class="text-slate-600 ml-2 text-[10px] normal-case">VLESS users, Hysteria2 up/down,
                            etc.</span>
                    </label>
                    <textarea name="settings" id="add_settings" rows="6" required
                        class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-3 text-xs text-emerald-400 font-mono focus:outline-none focus:border-indigo-500 transition-colors leading-relaxed">{}</textarea>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase mb-1">
                        Stream Settings JSON
                        <span class="text-slate-600 ml-2 text-[10px] normal-case">Transport, Security, Reality...</span>
                    </label>
                    <textarea name="stream_settings" id="add_stream_settings" rows="6" required
                        class="w-full bg-slate-950 border border-white/10 rounded-lg px-4 py-3 text-xs text-emerald-400 font-mono focus:outline-none focus:border-indigo-500 transition-colors leading-relaxed">{}</textarea>
                </div>

                <div class="flex justify-end pt-4 border-t border-white/5">
                    <button type="button" onclick="document.getElementById('add-inbound-modal').close()"
                        class="px-4 py-2 text-sm text-slate-400 hover:text-white transition-colors mr-2">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-medium rounded-xl shadow-lg shadow-indigo-600/20 transition-all active:scale-95">
                        Add Inbound
                    </button>
                </div>
            </form>
        </div>
    </dialog>
</section>

<script>
    document.getElementById('borrow-template-select').addEventListener('change', async function (e) {
        const tplId = e.target.value;
        if (!tplId) return;

        try {
            const adminPath = "{{ admin_path }}"; // From template binding
            const res = await fetch(`${adminPath}/templates/${tplId}/json`);
            if (!res.ok) throw new Error("Failed to fetch template");

            const tpl = await res.json();

            // Auto-fill form
            if (tpl.protocol) document.getElementById('add_protocol').value = tpl.protocol;

            // Parse and format JSON for pretty display
            try {
                const settingsObj = JSON.parse(tpl.settings_template || "{}");
                document.getElementById('add_settings').value = JSON.stringify(settingsObj, null, 2);
            } catch {
                document.getElementById('add_settings').value = tpl.settings_template || "{}";
            }

            try {
                const streamObj = JSON.parse(tpl.stream_settings_template || "{}");
                document.getElementById('add_stream_settings').value = JSON.stringify(streamObj, null, 2);
            } catch {
                document.getElementById('add_stream_settings').value = tpl.stream_settings_template || "{}";
            }

            // Optional: Auto-fill port if range start is set
            if (tpl.port_range_start > 0) {
                document.querySelector('input[name="listen_port"]').value = tpl.port_range_start;
            }

        } catch (err) {
            console.error(err);
            alert("Error loading template data: " + err.message);
        }
    });
</script>
{% endblock %}
